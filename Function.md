### **Полная техническая спецификация цифрового двойника**

| Логический блок | № | Название функции / Класса | Название файла | Куда он идет (вызывает) | Откуда он идет (вызывается) | Логика работы на примере |
|---|---|---|---|---|---|---|
| **---** | **--- ЯДРО СИМУЛЯЦИИ (SIM ENGINE) ---** | **---** | **---** | **---** | **---** |
| Ядро Симуляции | 1 | `run` | `simulation_manager.py` | `Simulate` | `SimulationService` | **Главная точка запуска.** Получает все данные для симуляции, проверяет режим (ручный/автоматический), вызывает `Simulate.run()`, возвращает `simulation_id`. |
| Ядро Симуляции | 2 | `__init__` | `simulation_manager.py` | (сохраняет `db`, `redis`) | `SimulationService` | **Инициализация.** При создании сервиса ему передают подключения к базе данных и Redis, которые он сохраняет для дальнейшего использования. |
| Ядро Симуляции | 3 | `solve` | `planner/solvers/greedy.py` | `_find_best_assignment`, `_calculate_cycle_time` | `Simulate` (в автоматическом режиме) | **Главная функция жадного алгоритма.** В цикле ищет лучшую связку "самосвал-экскаватор", рассчитывает время цикла, добавляет задание в план. |
| Ядро Симуляции | 4 | `_find_best_assignment` | `planner/solvers/greedy.py` | (внутренние вычисления) | `solve` | **Поиск оптимальной пары.** Из списка свободных самосвалов и экскаваторов находит ту пару, у которой минимальное время ожидания на данный момент. |
| Ядро Симуляции | 5 | `_calculate_cycle_time` | `planner/solvers/greedy.py` | (внутренние вычисления) | `solve` | **Расчет времени рейса.** Для пары "самосвал-экскаватор" суммирует время погрузки, движения груженым, разгрузки и движения порожним. |
| Ядро Симуляции | 6 | `process_unload` | `core/calculations/unload.py` | (возвращает `unload_time`) | `Simulate` (когда самосвал на разгрузке) | **Расчет времени разгрузки.** Использует формулу `unload_time = base_time + payload * coefficient`. |
| Ядро Симуляции | 7 | `process_load` | `core/calculations/shovel.py` | (возвращает `load_time`) | `Simulate` (когда самосвал под погрузкой) | **Расчет времени погрузки.** Использует захардкоженное время или формулу на основе типа экскаватора. |
| Ядро Симуляции | 8 | `calc_distance` | `core/calculations/geo_utils.py` | (возвращает `distance`) | `truck.py` (при расчете времени движения) | **Расчет расстояния.** На входе координаты двух точек, на выходе расстояние в метрах. |
| Ядро Симуляции | 9 | `local_to_global` | `core/calculations/geo_utils.py` | (возвращает `lat, lon, alt`) | `dxf_converter.py` | **Преобразование локальных координат в географические.** На входе координаты (100, 200) относительно якоря. На выходе (широта, долгота). |
| Ядро Симуляции | 10 | `collect_default_values` | `core/models.py` | (возвращает `result`) | (Вызывается при инициализации) | **Сбор значений по умолчанию для модели.** Собирает все поля с `default` в одно место. |
| Ядро Симуляции | 11 | `collect_default_values_of_all_models` | `core/models.py` | (возвращает `result`) | (Вызывается при инициализации) | **Сбор значений по умолчанию для всех моделей.** Агрегирует результаты `collect_default_values` для всех моделей в проекте. |
| Ядро Симуляции | 12 | `initial_location` | `core/models.py` | (возвращает `[lat, lon, height]`) | `Simulate` (для начальной позиции техники) | **Получение начальных координат.** Возвращает якорные координаты карьера как стартовую точку для техники. |
| Ядро Симуляции | 13 | `set_location` | `core/models.py` | (сохраняет `lat`, `lon`, `height` в БД) | `routes.py` (в `update_location`) | **Установка новых координат.** Сохраняет новые координаты объекта (например, карьера) в БД. |
| Ядро Симуляции | 14 | `types` | `core/models.py` | (возвращает `types_list`) | `routes.py` (для заполнения выпадающих списков) | **Получение списка всех возможных типов.** Для модели `Truck` вернет `['BELAZ', 'CAT', 'Komatsu']`. |
| Ядро Симуляции | 15 | `delete_with_file` | `core/models.py` | `os.remove` (удаляет файл с диска) | `routes.py` (в `handle_file_delete`) | **Удаление записи из БД и файла с диска.** При удалении загруженного DXF-файла, эта функция сначала удаляет файл с сервера, а потом запись о нем из БД. |
| Ядро Симуляции | 16 | `validate_schedule_type` | `core/models.py` | (возвращает `type`) | SQLAlchemy (при валидации данных в БД) | **Проверка, что тип расписания корректен.** Проверяет, что `schedule_type` является одним из разрешенных значений. |
| Ядро Симуляции | 17 | `validate_object_type` | `core/models.py` | (возвращает `type`) | SQLAlchemy (при валидации данных в БД) | **Проверка, что тип объекта корректен.** Проверяет, что `object_type` является одним из разрешенных значений. |
| Ядро Симуляции | 18 | `__init__` | `simulations/telemetry_emitter.py` | (сохраняет `redis_client`) | `Simulate` | **Инициализация.** Сохраняет клиент Redis для отправки телеметрии. |
| Ядро Симуляции | 19 | `emit_tick` | `simulations/telemetry_emitter.py` | `redis_client.lpush` | `Simulate` (на каждом тике) | **Отправка телеметрии за тик.** Формирует JSON с состоянием всех объектов и отправляет в Redis-список. |
| Ядро Симуляции | 20 | `TrackState` (Enum) | `states.py` | (используется по всему коду) | `Simulate` | **Справочник состояний самосвала.** Содержит константы: `MOVING`, `LOADING`, `UNLOADING`, `IDLE`, `REFUELING`. |
| Ядро Симуляции | 21 | `EventType` (Enum) | `events.py` | (используется по всему коду) | `Simulate` | **Справочник событий.** Содержит константы: `REPAIR_START`, `REPAIR_END`, `SHIFT_CHANGE`. |
| **---** | **--- API И ВЕБ-СЛОЙ ---** | **---** | **---** | **---** | **---** |
| API и Веб-слой | 22 | `index` | `routes.py` | `FileResponse('static/index.html')` | Веб-запрос к корню сайта | **Главная страница.** Отдает главную HTML-страницу фронтенда. |
| API и Веб-слой | 23 | `quarry_data` | `routes.py` | `QuarryDataService().call()` | Веб-запрос `/quarry_data` | **Получение всех данных по карьеру.** Вызывает сервис, который собирает всю информацию (техника, дороги, шаблоны) и отдает ее фронтенду. |
| API и Веб-слой | 24 | `schedule_data_by_date_shift` | `routes.py` | `ScheduleDataService().call()` | Веб-запрос `/schedule_data` | **Получение расписания.** Вызывает сервис, который фильтрует расписание по дате, карьеру и типу. |
| API и Веб-слой | 25 | `update_location` | `routes.py` | `Quarry.set_location()` | Веб-запрос `/update_location` | **Обновление координат.** Принимает новые координаты для карьера и сохраняет их в БД. |
| API и Веб-слой | 26 | `get_scenarios` | `routes.py` | `ScenarioService().fetch_all_with_assocs()` | Веб-запрос `/scenarios` | **Получение всех сценариев.** Вызывает сервис для получения списка всех сценариев с их связями. |
| API и Веб-слой | 27 | `create_object` | `routes.py` | `ObjectService.process()` | Веб-запрос `/object` (POST) | **Создание нового объекта.** Принимает данные формы, вызывает универсальный сервис `process` с действием 'create'. |
| API и Веб-слой | 28 | `update_object` | `routes.py` | `ObjectService.process()` | Веб-запрос `/object/{id}` (PUT) | **Обновление существующего объекта.** Принимает ID и данные, вызывает сервис `process` с действием 'update'. |
| API и Веб-слой | 29 | `delete_object` | `routes.py` | `ObjectService.process()` | Веб-запрос `/object` (DELETE) | **Удаление объекта.** Принимает ID, вызывает сервис `process` с действием 'delete'. |
| API и Веб-слой | 30 | `run_simulation` | `routes.py` | `SimulationService` | Веб-запрос `/run` | **Веб-входная точка для запуска.** Получает JSON с параметрами, создает сервис, вызывает его метод `run`, возвращает ID симуляции. |
| API и Веб-слой | 31 | `handle_file_get` | `routes.py` | `UploadedFile.query.get()` | Веб-запрос `/file/{id_or_name}` | **Получение информации о файле.** Ищет файл в БД по ID или имени, возвращает метаданные и URL. |
| API и Веб-слой | 32 | `handle_file_post` | `routes.py` | `UploadedFile` (ORM-модель) | Веб-запрос на загрузку файла | **Загрузка файла на сервер.** Сохраняет файл на диск, создает запись в БД, возвращает фронтенду информацию о загруженном файле. |
| API и Веб-слой | 33 | `handle_file_delete` | `routes.py` | `UploadedFile.delete_with_file()` | Веб-запрос `/file/{id_or_name}` | **Удаление файла.** Находит файл в БД и вызывает его метод для удаления и записи с диска. |
| API и Веб-слой | 34 | `collect_model_field_names` | `forms.py` | (внутренние вычисления) | (Вызывается для генерации полей) | **Сбор имен полей Pydantic-схемы.** Возвращает имена полей для динамического создания форм. |
| API и Веб-слой | 35 | `verify_template_bond` | `forms.py` | (обнуляет `template_id` у объекта) | `ObjectService` (перед сохранением) | **Проверка связи с шаблоном.** Если у объекта есть `template_id`, проверяет, совпадают ли поля шаблона и объекта. Если нет — обнуляет связь. |
| API и Веб-слой | 36 | `verify_template_bond_reversed` | `forms.py` | (удаляет `template_id` у связанных объектов) | `ObjectService` (при изменении шаблона) | **Обратная проверка связи.** Если у шаблона изменились поля, удаляет `template_id` у всех связанных с ним объектов. |
| API и Веб-слой | 37 | `delete_schedule_items` | `forms.py` | `db.session.delete()` | `handle_schedule_delete` | **Удаление элементов расписания.** Находит по времени и типу все записи расписания и удаляет их из БД. |
| API и Веб-слой | 38 | `handle_schedule_create` | `forms.py` | `JSONResponse` | `routes.py` | **Создание элементов расписания.** Принимает данные для blasting или planned_idle, создает записи в БД, возвращает успешный ответ. |
| API и Веб-слой | 39 | `handle_schedule_delete` | `forms.py` | `JSONResponse` | `routes.py` | **Удаление элементов расписания.** Вызывает `delete_schedule_items` и возвращает ответ с количеством удаленных записей. |
| API и Веб-слой | 40 | `validate_name_unique` | `forms.py` | (бросает исключение) | `routes.py` (перед сохранением) | **Проверка уникальности имени.** Перед сохранением нового объекта проверяет, что нет другого объекта с таким же именем. |
| API и Веб-слой | 41 | `instantiate_object` | `forms.py` | `populate_obj` | `ObjectService` | **Создание/загрузка ORM-объекта.** Проверяет наличие `id`. Если есть — загружает из БД, если нет — создает новый. |
| API и Веб-слой | 42 | `populate_obj` | `forms.py` | (заполняет поля объекта) | `instantiate_object` | **Заполнение объекта данными.** Берет данные из формы и заполняет поля объекта. |
| API и Веб-слой | 43 | `check_end_after_start` | `forms.py` | (возвращает `v`) | Pydantic-валидатор | **Проверка, что конечное время больше начального.** Используется для полей временных интервалов. |
| API и Веб-слой | 44 | `check_payload` | `forms.py` | (возвращает `v`) | Pydantic-валидатор | **Проверка корректности нагрузки.** Убеждается, что значение нагрузки находится в допустимых пределах. |
| API и Веб-слой | 45 | `check_unload_type` | `forms.py` | (возвращает `v`) | Pydantic-валидатор | **Проверка типа разгрузки.** Убеждается, что `unload_type` является одним из разрешенных значений. |
| API и Веб-слой | 46 | `validate_logic` | `forms.py` | (бросает исключение) | Pydantic-валидатор | **Кастомная валидация.** Содержит сложную логику проверки, которая не помещается в простые правила. |
| API и Веб-слой | 47 | `check_trail_type` | `forms.py` | (возвращает `v`) | Pydantic-валидатор | **Проверка типа трассы.** Убеждается, что `trail_type` является одним из разрешенных значений. |
| API и Веб-слой | 48 | `validate_timezone` | `forms.py` | (бросает исключение) | Pydantic-валидатор | **Проверка корректности часового пояса.** Проверяет, что указанная зона существует. |
| API и Веб-слой | 49 | `validate_shift_config` | `forms.py` | (бросает исключение) | Pydantic-валидатор | **Валидация конфигурации смен.** Проверяет, что конфигурация смен корректна (сумма часов в сутках равна 24). |
| API и Веб-слой | 50 | `validate_complex_rules` | `forms.py` | (бросает исключение) | Pydantic-валидатор | **Валидация сложных правил.** Проверяет логические связи между полями (например, время цикла > времени погрузки). |
| API и Веб-слой | 51 | `save_geojson_data` | `forms.py` | (сохраняет в `geojson_data` поле) | `ObjectService` (при сохранении `MapOverlay`) | **Сохранение GeoJSON данных.** Берет данные из поля формы и сохраняет их в соответствующее поле ORM-объекта. |
| API и Веб-слой | 52 | `validate_source_file_id_unique` | `forms.py` | (бросает исключение) | Pydantic-валидатор | **Проверка уникальности исходного файла.** Убеждается, что два `MapOverlay` не могут ссылаться на один и тот же исходный файл. |
| API и Веб-слой | 53 | `validate_convert_overlay_possible` | `forms.py` | (бросает исключение) | Pydantic-валидатор | **Проверка возможности конвертации.** Убеждается, что исходный файл для `MapOverlay` существует и является DXF. |
| API и Веб-слой | 54 | `convert_dxf` | `forms.py` | `dxf_converter.convert_dxf_to_geojson` | `ObjectService` (при сохранении `MapOverlay`) | **Конвертация DXF в GeoJSON.** Если указан `source_file_id`, находит файл, вызывает `dxf_converter`, сохраняет результат. |
| API и Веб-слой | 55 | `vehicle_type_allowed` | `forms.py` | (возвращает `v`) | Pydantic-валидатор | **Проверка типа техники.** Убеждается, что `vehicle_type` разрешен для данного типа объекта. |
| API и Веб-слой | 56 | `validate_vehicle_id_exists` | `forms.py` | (бросает исключение) | Pydantic-валидатор | **Проверка существования техники.** Убеждается, что техника с указанным `vehicle_id` существует в БД. |
| API и Веб-слой | 57 | `validate_no_time_overlap` | `forms.py` | (бросает исключение) | Pydantic-валидатор | **Проверка отсутствия пересечения по времени.** Убеждается, что новый интервал времени не пересекается с уже существующими для этого объекта. |
| **---** | **--- СЕРВИСНЫЙ СЛОЙ (SERVICES) ---** | **---** | **---** | **---** | **---** |
| Сервисный Слой | 58 | `__init__` | `services/object_service.py` | (сохраняет `db`) | (При создании сервиса) | **Инициализация.** Сохраняет сессию БД для дальнейших операций. |
| Сервисный Слой | 59 | `get_by_id` | `services/object_service.py` | `db.session.get()` | (Внутренний метод сервиса) | **Получение объекта по ID.** Универсальный метод для загрузки любого объекта из БД по его ID. |
| Сервисный Слой | 60 | `process` | `services/object_service.py` | `_prepare_data`, `_validate_form`, `_get_or_create` | `routes.py` | **Единый процессор для создания/обновления.** Готовит данные, валидирует, создает/загружает объект, применяет данные, сохраняет. |
| Сервисный Слой | 61 | `__init__` | `services/quarry_data_service.py` | (сохраняет `db_session`) | (При создании сервиса) | **Инициализация.** Сохраняет сессию БД. |
| Сервисный Слой | 62 | `fetch_all` | `services/quarry_data_service.py` | (возвращает список моделей) | `routes.py` | **Универсальная выборка данных.** `fetch_all(Truck)` выполнит `SELECT * FROM trucks ORDER BY id`. |
| Сервисный Слой | 63 | `fetch_roadnet_id_pairs` | `services/quarry_data_service.py` | (возвращает список кортежей) | (Внутренний метод) | **Получение ID дорожных сетей.** Возвращает список `(roadnet.id, roadnet.quarry_id)`. |
| Сервисный Слой | 64 | `fetch_map_overlays_deferred_geojson` | `services/quarry_data_service.py` | (возвращает список моделей) | (Внутренний метод) | **Получение оверлеев без GeoJSON.** Загружает `MapOverlay`, но не подгружает большое поле `geojson_data`. |
| Сервисный Слой | 65 | `fetch_trails_with_quarry_id` | `services/quarry_data_service.py` | (возвращает список кортежей) | (Внутренний метод) | **Получение трасс с ID карьера.** Возвращает список `(Trail, quarry_id)`. |
| Сервисный Слой | 66 | `__call__` | `services/quarry_data_service.py` | `_init_quarries`, `_load_related_models` | `routes.py` | **Агрегатор всех данных по карьеру.** Создает структуру для карьеров, загружает связанные данные, возвращает один большой DTO. |
| Сервисный Слой | 67 | `__init__` | `services/schedule_data_service.py` | (сохраняет `db_session`) | (При создании сервиса) | **Инициализация.** Сохраняет сессию БД. |
| Сервисный Слой | 68 | `fetch_filtered` | `services/schedule_data_service.py` | (возвращает отфильтрованные DTO) | `routes.py` | **Получение отфильтрованного расписания.** Выбирает из БД записи по дате, карьеру и типу, преобразует в DTO. |
| Сервисный Слой | 69 | `__call__` | `services/schedule_data_service.py` | `_resolve_time_window` | `routes.py` | **Основная точка входа.** Определяет временной диапазон и вызывает `fetch_filtered`. |
| Сервисный Слой | 70 | `__init__` | `services/simulation_id_service.py` | (сохраняет `db_session`) | (При создании сервиса) | **Инициализация.** Сохраняет сессию БД. |
| Сервисный Слой | 71 | `fetch_road_net_by_id` | `services/simulation_id_service.py` | `RoadNet.query.get()` | (Внутренний метод) | **Получение дорожной сети.** Загружает `RoadNet` из БД по ID. |
| Сервисный Слой | 72 | `get_filtered_schedule_items` | `services/simulation_id_service.py` | (возвращает `item_list`) | (Внутренний метод) | **Получение отфильтрованного расписания.** Выбирает из БД записи расписания для симуляции. |
| Сервисный Слой | 73 | `fetch_schedules` | `services/simulation_id_service.py` | (возвращает `schedules`) | (Внутренний метод) | **Получение расписаний.** Загружает `blasting` и `planned_idle` расписания для карьера. |
| Сервисный Слой | 74 | `SimulationDataHandler.__init__` | `services/simulation_id_service.py` | (сохраняет `data`, `db`, `redis_client`) | (При создании обработчика) | **Инициализация обработчика данных.** Сохраняет данные симуляции, БД и Redis. |
| Сервисный Слой | 75 | `_store_simulation_data` | `services/simulation_id_service.py` | `redis_client.set` | `SimulationDataHandler` | **Сохранение результатов.** Записывает результаты симуляции (мета, телеметрию) в Redis с TTL. |
| Сервисный Слой | 76 | `_cleanup_old_simulations` | `services/simulation_id_service.py` | `redis_client.delete` | `SimulationDataHandler` | **Очистка старых симуляций.** Удаляет самые старые симуляции, чтобы не переполнять Redis. |
| Сервисный Слой | 77 | `__init__` | `services/template_service.py` | (сохраняет `db_session`) | (При создании сервиса) | **Инициализация.** Сохраняет сессию БД. |
| Сервисный Слой | 78 | `fetch_all` | `services/template_service.py` | (возвращает `result`) | (Вызывается для получения всех шаблонов) | **Получение всех шаблонов.** Выполняет `select().order_by(id.asc())` для указанной модели. |
| Сервисный Слой | 79 | `TemplateAggregator.__init__` | `services/template_service.py` | (сохраняет `db_session`) | (При создании агрегатора) | **Инициализация агрегатора.** Сохраняет сессию БД. |
| Сервисный Слой | 80 | `_model_to_dict_list` | `services/template_service.py` | (возвращает список словарей) | `TemplateAggregator` | **Преобразование моделей в словари.** Преобразует список ORM-объектов в список словарей. |
| Сервисный Слой | 81 | `_generate_templates_dict` | `services/template_service.py` | (возвращает `result`) | `TemplateAggregator` | **Генерация словаря шаблонов.** Создает структурированный словарь со всеми шаблонами. |
| Сервисный Слой | 82 | `__call__` | `services/template_service.py` | `_generate_templates_dict` | `routes.py` | **Основная точка входа.** Вызывает `_generate_templates_dict` и возвращает результат. |
| Сервисный Слой | 83 | `__init__` | `services/scenario_service.py` | (сохраняет `db_session`) | (При создании сервиса) | **Инициализация.** Сохраняет сессию БД. |
| Сервисный Слой | 84 | `fetch_all_with_assocs` | `services/scenario_service.py` | (возвращает `scenarios`) | (Вызывается для получения сценариев) | **Получение всех сценариев.** Загружает все сценарии вместе с их связями (трассы, самосвалы). |
| Сервисный Слой | 85 | `fetch_trails_by_quarry` | `services/scenario_service.py` | (возвращает `trails`) | (Внутренний метод) | **Получение трасс по карьеру.** Загружает трассы, принадлежащие указанному карьеру. |
| Сервисный Слой | 86 | `ScenarioBuilder.__init__` | `services/scenario_service.py` | (сохраняет `db_session`) | (При создании билдера) | **Инициализация билдера.** Сохраняет сессию БД. |
| Сервисный Слой | 87 | `__call__` | `services/scenario_service.py` | `_scenario_to_dto` | `routes.py` | **Основная точка входа.** Строит DTO для всех сценариев. |
| Сервисный Слой | 88 | `_scenario_to_dto` | `services/scenario_service.py` | `_build_assoc_map`, `_load_and_transform_trails` | `ScenarioBuilder` | **Преобразование сценария в DTO.** Создает DTO для одного сценария. |
| Сервисный Слой | 89 | `_build_assoc_map` | `services/scenario_service.py` | (возвращает `assoc_by_trail`) | `_scenario_to_dto` | **Построение карты связей.** Создает словарь `{trail_id: [truck_id, ...]}`. |
| Сервисный Слой | 90 | `_load_and_transform_trails` | `services/scenario_service.py` | `_trail_to_dto` | `_scenario_to_dto` | **Загрузка и трансформация трасс.** Загружает трассы из БД и преобразует их в DTO. |
| Сервисный Слой | 91 | `_trail_to_dto` | `services/scenario_service.py` | `_parse_segments` | `_load_and_transform_trails` | **Преобразование трассы в DTO.** Создает DTO для одной трассы, парся ее `raw_graph`. |
| Сервисный Слой | 92 | `_parse_segments` | `services/scenario_service.py` | (внутренняя логика) | `_trail_to_dto` | **Парсинг сегментов.** Преобразует строковое представление графа в список сегментов. |
| **---** | **--- МОДЕЛИ ДАННЫХ (MODELS) ---** | **---** | **---** | **---** | **---** |
| Модели Данных | 93 | `__repr__` | `core/models.py` | (возвращает `f'<{...}>'`) | (Вызывается при печати объекта) | **Строковое представление объекта.** Возвращает красивую строку с ID и именем объекта. |
| Модели Данных | 94 | `types` | `core/models.py` | (возвращает `types_list`) | `routes.py` (для заполнения выпадающих списков) | **Получение списка всех возможных типов.** Для модели `Truck` вернет `['BELAZ', 'CAT', 'Komatsu']`. |
| Модели Данных | 95 | `__repr__` | `core/models.py` | (возвращает `f'<{...}>'`) | (Вызывается при печати объекта) | **Строковое представление объекта.** Возвращает строку с ID связанного оборудования. |
| Модели Данных | 96 | `__repr__` | `core/models.py` | (возвращает `f'<{...}>'`) | (Вызывается при печати объекта) | **Строковое представление объекта.** Возвращает строку с ID связанной трассы и самосвала. |
| Модели Данных | 97 | `__repr__` | `core/models.py` | (возвращает `f'<{...}>'`) | (Вызывается при печати объекта) | **Строковое представление объекта.** Возвращает строку с ID объекта. |
| Модели Данных | 98 | `__repr__` | `core/models.py` | (возвращает `f'<{...}>'`) | (Вызывается при печати объекта) | **Строковое представление объекта.** Возвращает строку с именем объекта. |
| **---** | **--- КОНФИГУРАЦИЯ И УТИЛИТЫ ---** | **---** | **---** | **---** | **---** |
| Конфигурация и Утилиты | 99 | `__init__` | `dxf_converter.py` | (сохраняет `anchor_lat`, `anchor_lon`, `anchor_height`) | (При создании объекта) | **Инициализация.** Устанавливает якорную точку для преобразования локальных координат в географические. |
| Конфигурация и Утилиты | 100 | `convert_coords` | `dxf_converter.py` | (возвращает `(lat, lon, alt)`) | `process_*` методы | **Преобразование координат.** Преобразует локальные (x, y, z) в глобальные (широта, долгота, высота). |
| Конфигурация и Утилиты | 101 | `safe_geojson_coords` | `dxf_converter.py` | (возвращает `(y, x, z)` или `(y, x)`) | `process_*` методы | **Безопасное преобразование в GeoJSON.** Округляет координаты и форматирует их в соответствии со стандартом GeoJSON. |
| Конфигурация и Утилиты | 102 | `extract_elevation_from_str` | `dxf_converter.py` | (возвращает `elevation`) | `process_*` методы | **Извлечение высоты из имени слоя.** Из `LEVEL_150.0` извлекает `150.0`. |
| Конфигурация и Утилиты | 103 | `process_line` | `dxf_converter.py` | (возвращает `feature`) | `convert_dxf_to_geojson` | **Обработка прямой линии.** Преобразует сущность LINE из DXF в GeoJSON `LineString`. |
| Конфигурация и Утилиты | 104 | `process_polyline` | `dxf_converter.py` | (возвращает `feature`) | `convert_dxf_to_geojson` | **Обработка полилинии.** Преобразует POLYLINE в GeoJSON `LineString` или `Polygon`. |
| Конфигурация и Утилиты | 105 | `process_lwpolyline` | `dxf_converter.py` | (возвращает `feature`) | `convert_dxf_to_geojson` | **Обработка легковесной полилинии.** Преобразует LWPOLYLINE в GeoJSON. |
| Конфигурация и Утилиты | 106 | `convert_dxf_to_geojson` | `dxf_converter.py` | `process_line`, `process_polyline` | `forms.py` | **Главная функция конвертации.** Открывает DXF, итерируется по сущностям, вызывает `process_*`, собирает в `FeatureCollection`. |
| Конфигурация и Утилиты | 107 | `__init__` | `road_net.py` | (сохраняет `quarry_id`) | (При создании объекта) | **Инициализация.** Создает объект дорожной сети для конкретного карьера. |
| Конфигурация и Утилиты | 108 | `clean` | `road_net.py` | `__clean_graph_bonds_by_schema`, `__clean_graph_bonds_by_data` | (Вызывается для очистки данных) | **Очистка данных графа.** Вызывает внутренние функции для проверки и очистки данных о связях точек. |
| Конфигурация и Утилиты | 109 | `__clean_graph_bonds_by_schema` | `road_net.py` | (внутренняя логика) | `clean` | **Очистка по схеме.** Проверяет, что связи в графе соответствуют разрешенной схеме. Удаляет некорректные связи. |
| Конфигурация и Утилиты | 110 | `__clean_graph_bonds_by_data` | `road_net.py` | (внутренняя логика) | `clean` | **Очистка по данным.** Проверяет, что связи в графе ведут к существующим точкам. Удаляет некорректные связи. |
| Конфигурация и Утилиты | 111 | `ShiftError.__init__` | `shift.py` | (сохраняет `message`, `status_code`) | (При создании исключения) | **Инициализация ошибки.** Создает исключение с сообщением и кодом ошибки. |
| Конфигурация и Утилиты | 112 | `__str__` | `shift.py` | (возвращает `self.message`) | (При выводе ошибки) | **Строковое представление ошибки.** Возвращает сообщение об ошибке. |
| Конфигурация и Утилиты | 113 | `ShiftLogic.__init__` | `shift.py` | (сохраняет `offsets_tuple`) | `ShiftLogic.factory` | **Инициализация логики смен.** Принимает кортеж со смещениями для каждой смены. |
| Конфигурация и Утилиты | 114 | `ShiftLogic.factory` | `shift.py` | `ShiftLogic(...)` | `services/date_time_service.py` | **Фабрика для создания логики смен.** Создает объект `ShiftLogic` на основе конфигурации. |
| Конфигурация и Утилиты | 115 | `ShiftLogic.validate_shift_config` | `shift.py` | (внутренняя логика) | `ShiftLogic.factory` | **Валидация конфигурации смен.** Проверяет, что конфигурация корректна (не пересекаются смены, покрывают 24 часа). |
| Конфигурация и Утилиты | 116 | `ShiftLogic.for_date` | `shift.py` | (возвращает `result`) | `services/date_time_service.py` | **Получение всех смен для даты.** Для `2023-10-27` вернет список утренней, дневной и ночной смен. |
| Конфигурация и Утилиты | 117 | `ShiftLogic.for_datetime` | `shift.py` | (возвращает `ShiftDTO`) | `Simulate` | **Определение смены для момента времени.** Для `2023-10-27 15:30` вернет объект дневной смены. |
| Конфигурация и Утилиты | 118 | `ShiftLogic.for_range` | `shift.py` | (возвращает `result`) | (Вызывается для получения списка смен) | **Получение смен за период.** Возвращает все смены, которые попадают в указанный временной интервал. |
| Конфигурация и Утилиты | 119 | `ShiftLogic.prev_from` | `shift.py` | (возвращает `ShiftDTO`) | (Вызывается для поиска предыдущей смены) | **Поиск предыдущей смены.** Находит смену, которая была перед указанной. |
| Конфигурация и Утилиты | 120 | `ShiftLogic.next_from` | `shift.py` | (возвращает `ShiftDTO`) | (Вызывается для поиска следующей смены) | **Поиск следующей смены.** Находит смену, которая идет после указанной. |
| Конфигурация и Утилиты | 121 | `utc_now` | `utils.py` | (возвращает `datetime`) | (Вызывается для получения текущего времени) | **Получение текущего времени в UTC.** Возвращает `datetime` объект с текущим временем в UTC. |
| Конфигурация и Утилиты | 122 | `utc_to_enterprise` | `utils.py` | (возвращает `datetime`) | `services/date_time_service.py` | **Конвертация времени из UTC в локальную.** `10:00 UTC` для `Asia/Yekaterinburg` -> `15:00`. |
| Конфигурация и Утилиты | 123 | `enterprise_to_utc` | `utils.py` | (возвращает `datetime`) | `forms.py` (при сохранении времени) | **Конвертация локального времени в UTC.** Пользователь вводит `15:00`, сохранится как `10:00 UTC`. |
| Конфигурация и Утилиты | 124 | `str_to_snake_case` | `utils.py` | (возвращает `s`) | (Вспомогательная функция) | **Преобразование строки в snake_case.** `MyClassName` -> `my_class_name`. |
| Конфигурация и Утилиты | 125 | `secure_filename` | `utils.py` | (возвращает `filename`) | `routes.py` (при загрузке файла) | **Очистка имени файла.** `../../../etc/passwd` -> `etc_passwd`. Защищает от атак. |
| Конфигурация и Утилиты | 126 | `human_size` | `utils.py` | (возвращает `f'{size:.1f}{unit}'`) | (Вызывается для отображения размера файла) | **Форматирование размера файла.** `1048576` байт -> `1.0 MB`. |
| Конфигурация и Утилиты | 127 | `generate_simulation_data` | `app/simulate_test.py` | (возвращает `{'status': 'ok', ...}`) | (Вызывается для генерации тестовых данных) | **Генератор тестовых данных.** Создает фейковые данные телеметрии и сводки для тестирования фронтенда. |
| Конфигурация и Утилиты | 128 | `TruckType.__str__` | `app/sim_engine/enums.py` | (возвращает `self.value`) | (Вызывается при отображении типа) | **Строковое представление типа самосвала.** Возвращает человеко-читаемое название типа. |
| Конфигурация и Утилиты | 129 | `TruckType.ru` | `app/sim_engine/enums.py` | (возвращает `self._ru_map[self.value]`) | (Вызывается для отображения на UI) | **Русское название типа самосвала.** Возвращает название на русском языке. |
| Конфигурация и Утилиты | 130 | `UnloadType.__str__` | `app/sim_engine/enums.py` | (возвращает `self.value`) | (Вызывается при отображении типа) | **Строковое представление типа разгрузки.** |
| Конфигурация и Утилиты | 131 | `UnloadType.ru` | `app/sim_engine/enums.py` | (возвращает `self._ru_map[self.value]`) | (Вызывается для отображения на UI) | **Русское название типа разгрузки.** |
| Конфигурация и Утилиты | 132 | `Event.__str__` | `app/sim_engine/events.py` | (возвращает `self.message`) | (Вызывается при логировании события) | **Строковое представление события.** Возвращает сообщение о событии. |
| Конфигурация и Утилиты | 133 | `Event.code` | `app/sim_engine/events.py` | (возвращает `self._code`) | (Вызывается для идентификации) | **Код события.** Возвращает уникальный код события. |
| **---** | **--- МИГРАЦИИ БАЗЫ ДАННЫХ ---** | **---** | **---** | **---** | **---** |
| Миграции БД | 134 | `run_migrations_offline` | `app/migrations/env.py` | (внутренняя логика Alembic) | `alembic` командная строка | **Запуск миграций в оффлайн-режиме.** Применяет изменения к БД без подключения, генерируя SQL-скрипт. |
| Миграции БД | 135 | `run_migrations_online` | `app/migrations/env.py` | (внутренняя логика Alembic) | `alembic` командная строка | **Запуск миграций в онлайн-режиме.** Подключается к БД и применяет изменения напрямую. |
| Миграции БД | 136 | `upgrade` | `app/migrations/versions/049327069ed2_add_arm_turn_angle_to_shovel.py` | `op.add_column('shovel_template', ...)` | `alembic upgrade head` | **Добавляет колонку `arm_turn_angle` в таблицу `shovel_template`.** |
| Миграции БД | 137 | `downgrade` | `app/migrations/versions/049327069ed2_add_arm_turn_angle_to_shovel.py` | `op.drop_column('shovel_template', ...)` | `alembic downgrade base` | **Удаляет колонку `arm_turn_angle` из таблицы `shovel_template`.** |
| Миграции БД | 138 | `upgrade` | `app/migrations/versions/173b757501f6_add_scenario_model.py` | `op.create_table('scenario', ...)` | `alembic upgrade head` | **Создает таблицу `scenario` для хранения сценариев.** |
| Миграции БД | 139 | `downgrade` | `app/migrations/versions/173b757501f6_add_scenario_model.py` | `op.drop_table('scenario')` | `alembic downgrade base` | **Удаляет таблицу `scenario`.** |
| Миграции БД | 140 | `upgrade` | `app/migrations/versions/2f3ca3217c27_add_blasting_model.py` | `op.create_table('blasting', ...)` | `alembic upgrade head` | **Создает таблицу `blasting` для хранения расписания взрывных работ.** |
| Миграции БД | 141 | `downgrade` | `app/migrations/versions/2f3ca3217c27_add_blasting_model.py` | `op.drop_table('blasting')` | `alembic downgrade base` | **Удаляет таблицу `blasting`.** |
| Миграции БД | 142 | `upgrade` | `app/migrations/versions/34d2db5b9f3c_drop_columns.py` | `op.drop_column(...)` | `alembic upgrade head` | **Удаляет несколько колонок из разных таблиц (рефакторинг).** |
| Миграции БД | 143 | `downgrade` | `app/migrations/versions/34d2db5b9f3c_drop_columns.py` | `op.add_column(...)` | `alembic downgrade base` | **Добавляет обратно удаленные колонки (откат рефакторинга).** |
| Миграции БД | 144 | `upgrade` | `app/migrations/versions/5e034f7cece7_initial_migration_attempt_3.py` | `op.create_table(...)` | `alembic upgrade head` | **Начальная миграция.** Создает основной набор таблиц для проекта.** |
| Миграции БД | 145 | `downgrade` | `app/migrations/versions/5e034f7cece7_initial_migration_attempt_3.py` | `op.drop_table(...)` | `alembic downgrade base` | **Удаляет все таблицы, созданные в начальной миграции.** |
| Миграции БД | 146 | `upgrade` | `app/migrations/versions/660043dae00e_add_shoveltemplate_trucktemplate_.py` | `op.create_table(...)` | `alembic upgrade head` | **Создает таблицы `shovel_template` и `truck_template` для шаблонов техники.** |
| Миграции БД | 147 | `downgrade` | `app/migrations/versions/66043dae00e_add_shoveltemplate_trucktemplate_.py` | `op.drop_table(...)` | `alembic downgrade base` | **Удаляет таблицы шаблонов.** |
| Миграции БД | 148 | `upgrade` | `app/migrations/versions/689dff3c9f22_new_fields_for_shovel_truck_and_unload.py` | `op.add_column(...)` | `alembic upgrade head` | **Добавляет новые поля в таблицы `shovel`, `truck`, `unload`.** |
| Миграции БД | 149 | `downgrade` | `app/migrations/versions/689dff3c9f22_new_fields_for_shovel_truck_and_unload.py` | `op.drop_column(...)` | `alembic downgrade base` | **Удаляет добавленные поля.** |
| Миграции БД | 150 | `upgrade` | `app/migrations/versions/741a88f7abe1_add_scenario_relation_to_.py` | `op.create_table(...)` | `alembic upgrade head` | **Создает таблицы для связей сценариев с трассами и техникой.** |
| Миграции БД | 151 | `downgrade` | `app/migrations/versions/741a88f7abe1_add_scenario_relation_to_.py` | `op.drop_table(...)` | `alembic downgrade base` | **Удаляет таблицы связей сценариев.** |
| Миграции БД | 152 | `upgrade` | `app/migrations/versions/77aa09bc992e_add_primary_key_to_scenario_id_in_.py` | `op.create_primary_key(...)` | `alembic upgrade head` | **Добавляет первичный ключ в таблицу связей сценариев.** |
| Миграции БД | 153 | `downgrade` | `app/migrations/versions/77aa09bc992e_add_primary_key_to_scenario_id_in_.py` | `op.drop_constraint(...)` | `alembic downgrade base` | **Удаляет первичный ключ из таблицы связей сценариев.** |
| Миграции БД | 154 | `upgrade` | `app/migrations/versions/8520318762c4_rename_shiftchangearea_to_idlearea.py` | `op.alter_table('shift_change_area', rename_to='idle_area')` | `alembic upgrade head` | **Переименовывает таблицу `shift_change_area` в `idle_area`.** |
| Миграции БД | 155 | `downgrade` | `app/migrations/versions/8520318762c4_rename_shiftchangearea_to_idlearea.py` | `op.alter_table('idle_area', rename_to='shift_change_area')` | `alembic downgrade base` | **Откатывает переименование таблицы.** |
| Миграции БД | 156 | `upgrade` | `app/migrations/versions/8d394792dc14_add_shift_change_fields_to_quarry.py` | `op.add_column(...)` | `alembic upgrade head` | **Добавляет поля для смен в таблицу `quarry`.** |
| Миграции БД | 157 | `downgrade` | `app/migrations/versions/8d394792dc14_add_shift_change_fields_to_quarry.py` | `op.drop_column(...)` | `alembic downgrade base` | **Удаляет поля для смен из таблицы `quarry`.** |
| Миграции БД | 158 | `upgrade` | `app/migrations/versions/9daa452a370b_new_reliability_related_fields_for_.py` | `op.add_column(...)` | `alembic upgrade head` | **Добавляет поля, связанные с надежности, в таблицы техники.** |
| Миграции БД | 159 | `downgrade` | `app/migrations/versions/9daa452a370b_new_reliability_related_fields_for_.py` | `op.drop_column(...)` | `alembic downgrade base` | **Удаляет поля надежности.** |
| Миграции БД | 160 | `upgrade` | `app/migrations/versions/a06b87cc0807_add_shiftchangearea_and_fuelstation_.py` | `op.create_table(...)` | `alembic upgrade head` | **Создает таблицы `shift_change_area` и `fuel_station`.** |
| Миграции БД | 161 | `downgrade` | `app/migrations/versions/a06b87cc0807_add_shiftchangearea_and_fuelstation_.py` | `op.drop_table(...)` | `alembic downgrade base` | **Удаляет таблицы `shift_change_area` и `fuel_station`.** |
| Миграции БД | 162 | `upgrade` | `app/migrations/versions/a43abb6acab2_add_uploadedfile_and_mapoverlay.py` | `op.create_table(...)` | `alembic upgrade head` | **Создает таблицы `uploaded_file` и `map_overlay` для загрузки файлов и оверлеев.** |
| Миграции БД | 163 | `downgrade` | `app/migrations/versions/a43abb6acab2_add_uploadedfile_and_mapoverlay.py` | `op.drop_table(...)` | `alembic downgrade base` | **Удаляет таблицы `uploaded_file` и `map_overlay`.** |
| Миграции БД | 164 | `upgrade` | `app/migrations/versions/b7dcacd91b4a_add_quarry.py` | `op.create_table('quarry', ...)` | `alembic upgrade head` | **Создает таблицу `quarry` для хранения информации о карьерах.** |
| Миграции БД | 165 | `downgrade` | `app/migrations/versions/b7dcacd91b4a_add_quarry.py` | `op.drop_table('quarry')` | `alembic downgrade base` | **Удаляет таблицу `quarry`.** |
| Миграции БД | 166 | `upgrade` | `app/migrations/versions/c5fb8550f985_add_plannedidle.py` | `op.create_table('planned_idle', ...)` | `alembic upgrade head` | **Создает таблицу `planned_idle` для хранения плановых простоев.** |
| Миграции БД | 167 | `downgrade` | `app/migrations/versions/c5fb8550f985_add_plannedidle.py` | `op.drop_table('planned_idle')` | `alembic downgrade base` | **Удаляет таблицу `planned_idle`.** |
| Миграции БД | 168 | `upgrade` | `app/migrations/versions/f07a8f73270d_update_unload_payload_type_values.py` | `op.execute("UPDATE ...")` | `alembic upgrade head` | **Обновляет значения в колонке `payload_type` таблицы `unload`.** |
| Миграции БД | 169 | `downgrade` | `app/migrations/versions/f07a8f73270d_update_unload_payload_type_values.py` | `op.execute("UPDATE ...")` | `alembic downgrade base` | **Откатывает значения `payload_type` к предыдущим.** |
| Миграции БД | 170 | `upgrade` | `app/migrations/versions/fa791c45aefa_add_field_is_repair_area_to_idlearea.py` | `op.add_column('idle_area', ...)` | `alembic upgrade head` | **Добавляет поле `is_repair_area` в таблицу `idle_area`.** |
| Миграции БД | 171 | `downgrade` | `app/migrations/versions/fa791c45aefa_add_field_is_repair_area_to_idlearea.py` | `op.drop_column('idle_area', ...)` | `alembic downgrade base` | **Удаляет поле `is_repair_area`.** |
| Миграции БД | 172 | `upgrade` | `app/migrations/versions/fea74ce0faa7_add_roadnet.py` | `op.create_table('roadnet', ...)` | `alembic upgrade head` | **Создает таблицу `roadnet` для хранения дорожных сетей.** |
| Миграции БД | 173 | `downgrade` | `app/migrations/versions/fea74ce0faa7_add_roadnet.py` | `op.drop_table('roadnet')` | `alembic downgrade base` | **Удаляет таблицу `roadnet`.** |
| **---** | **--- ИНИЦИАЛИЗАЦИЯ ПРИЛОЖЕНИЯ ---** | **---** | **---** | **---** | **---** |
| Инициализация | 174 | `get_db` | `app/__init__.py` | (возвращает `g.db`) | `routes.py` (через `@db` декоратор) | **Получение сессии БД.** Возвращает сессию базы данных, привязанную к текущему запросу (Flask `g` object). |
| Инициализация | 175 | `get_redis` | `app/__init__.py` | (возвращает `redis_client`) | `routes.py` (через `@redis` декоратор) | **Получение клиента Redis.** Возвращает клиент Redis, привязанный к текущему приложению. |
| Инициализация | 176 | `create_app` | `app/__init__.py` | (конфигурирует и возвращает `app`) | (Вызывается для запуска приложения) | **Фабрика приложения.** Создает и конфигурирует Flask-приложение: регистрирует блюпринты, middleware, обработчики ошибок. |
