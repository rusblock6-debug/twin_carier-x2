<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ü–æ—Ç–æ–∫–∏ –¥–∞–Ω–Ω—ã—Ö —Å–∏—Å—Ç–µ–º—ã - qsimmine12</title>
    <script src="https://unpkg.com/cytoscape@3.26.0/dist/cytoscape.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            display: flex; flex-direction: column;
            height: 100vh; overflow: hidden;
            background: #f5f7fa;
        }
        .header {
            background: linear-gradient(135deg, #2c3e50, #34495e);
            color: white; padding: 12px 20px;
            display: flex; align-items: center; gap: 12px;
            flex-wrap: wrap; box-shadow: 0 2px 10px rgba(0,0,0,0.15);
        }
        .header h1 { font-size: 20px; font-weight: 500; margin-right: auto; }
        .header-controls, .header-actions { display: flex; gap: 8px; flex-wrap: wrap; align-items: center; }
        .search-input {
            padding: 8px 12px; border-radius: 4px; border: none;
            min-width: 220px; font-size: 14px;
        }
        .btn {
            padding: 7px 16px; border-radius: 4px; border: none;
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: #fff; cursor: pointer; font-size: 13px;
            transition: all .2s ease; box-shadow: 0 2px 4px rgba(0,0,0,0.15);
        }
        .btn-secondary { background: linear-gradient(135deg, #95a5a6, #7f8c8d); }
        .btn-icon { padding: 7px 10px; font-size: 16px; }
        .btn:hover:not(:disabled) { transform: translateY(-1px); box-shadow: 0 4px 8px rgba(0,0,0,0.2); }
        .btn:disabled { background: #bfc4c6; cursor: not-allowed; }
        .filters-panel {
            background: white; padding: 10px 20px;
            border-bottom: 1px solid #e1e8ed;
            display: flex; flex-wrap: wrap; gap: 20px;
            align-items: center;
        }
        .layer-controls { display: flex; flex-wrap: wrap; gap: 10px; align-items: center; }
        .layer-filters {
            display: flex; gap: 10px; flex-wrap: wrap;
            max-height: 80px; overflow-y: auto;
        }
        .layer-chip {
            padding: 5px 10px; border-radius: 14px;
            border: 1px solid #d5dce3;
            background: #f3f5f7; font-size: 12px;
            cursor: pointer; display: flex; gap: 6px; align-items: center;
        }
        .layer-chip input { cursor: pointer; }
        .main-container { flex:1; display:flex; padding:15px; gap:15px; overflow:hidden; }
        .graph-container {
            flex:1; display:flex; background:white;
            border-radius:10px; border:1px solid #e1e8ed;
            box-shadow:0 2px 8px rgba(0,0,0,0.08); overflow:hidden;
        }
        #cy { flex:1; min-width:0; min-height:0; background:#f8fafc; }
        .sidebar {
            width:380px; border-left:1px solid #e1e8ed;
            display:flex; flex-direction:column; background:white;
        }
        .sidebar-header { padding:18px 20px; background:#f1f4f8; border-bottom:1px solid #e1e8ed; }
        .sidebar-header h2 { font-size:17px; margin-bottom:6px; color:#2c3e50; }
        .stats { font-size:12px; color:#5d6d7e; }
        .sidebar-content { padding:20px; overflow-y:auto; flex:1; }
        .sidebar-empty { text-align:center; color:#7f8c8d; margin-top:40px; font-style:italic; }
        .info-row { margin-bottom:16px; padding-bottom:16px; border-bottom:1px solid #eef1f4; }
        .info-label { font-size:12px; color:#7f8c8d; letter-spacing:0.5px; margin-bottom:6px; text-transform:uppercase; }
        .info-value { color:#2c3e50; font-size:14px; line-height:1.5; }
        .category-badge { padding:3px 8px; border-radius:12px; font-size:11px; margin-left:6px; background:#ecf0f1; }
        .flow-info { background:#f4fbf6; border-left:4px solid #2ecc71; padding:10px 12px; margin:8px 0; border-radius:4px; font-size:13px; }
        .flow-info span.unit { color:#7f8c8d; font-size:11px; }
        .formula-block { background:#1f2933; color:#f5f7fa; padding:12px; border-radius:6px; font-family:'Fira Code', monospace; font-size:13px; }
        .parameter-list { list-style:none; padding:0; margin:0; }
        .parameter-item { background:#f6f8fb; border-left:3px solid #3498db; padding:8px 10px; margin:4px 0; border-radius:4px; font-size:13px; }
        .legend { display:flex; flex-wrap:wrap; gap:8px; font-size:12px; }
        .legend-item { display:flex; align-items:center; gap:4px; }
        .legend-color { width:12px; height:12px; border-radius:3px; }
        .data-flow-highlight { background-color:#00b894 !important; border-color:#009874 !important; border-width:4px !important; color:#fff !important; }
        .data-flow-edge { width:5px !important; line-color:#00b894 !important; target-arrow-color:#00b894 !important; opacity:1 !important; }
    </style>
</head>
<body>
    <div class="header">
        <h1>üîç –ü–æ—Ç–æ–∫–∏ –¥–∞–Ω–Ω—ã—Ö —Å–∏—Å—Ç–µ–º—ã qsimmine12</h1>
        <div class="header-controls">
            <input type="file" id="fileInput" accept=".json" style="display:none;">
            <button class="btn" onclick="document.getElementById('fileInput').click()">–ó–∞–≥—Ä—É–∑–∏—Ç—å JSON</button>
            <input type="text" id="searchInput" class="search-input" placeholder="–ü–æ–∏—Å–∫ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é...">
        </div>
        <div class="header-actions">
            <button class="btn-icon" onclick="fitToScreen()" title="–ü–æ–∫–∞–∑–∞—Ç—å –≤—Å–µ">‚ä°</button>
            <button class="btn-icon" onclick="zoomIn()" title="–ü—Ä–∏–±–ª–∏–∑–∏—Ç—å">+</button>
            <button class="btn-icon" onclick="zoomOut()" title="–û—Ç–¥–∞–ª–∏—Ç—å">‚àí</button>
            <button class="btn btn-secondary" onclick="isolateFocusedNode()" title="–ü–æ–∫–∞–∑–∞—Ç—å —Ç–æ–ª—å–∫–æ –≤—ã–±—Ä–∞–Ω–Ω—ã–π">–ò–∑–æ–ª–∏—Ä–æ–≤–∞—Ç—å</button>
            <button class="btn btn-secondary" onclick="resetVisibility()" title="–°–±—Ä–æ—Å–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä—ã">–°–±—Ä–æ—Å</button>
        </div>
    </div>

    <div class="filters-panel">
        <div>
            <strong>–°–ª–æ–∏:</strong>
            <div class="layer-filters" id="layerFilters"></div>
        </div>
        <div class="layer-controls">
            <button class="btn btn-secondary" onclick="selectAllLayers()">–ü–æ–∫–∞–∑–∞—Ç—å –≤—Å–µ</button>
            <button class="btn btn-secondary" onclick="deselectAllLayers()">–°–∫—Ä—ã—Ç—å –≤—Å–µ</button>
        </div>
        <div class="legend" id="layerLegend"></div>
    </div>

    <div class="main-container">
        <div class="graph-container">
            <div id="cy"></div>
            <div class="sidebar">
                <div class="sidebar-header">
                    <h2>–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</h2>
                    <div class="stats" id="stats"></div>
                </div>
                <div class="sidebar-content" id="sidebarContent">
                    <div class="sidebar-empty">
                        –ö–ª–∏–∫–Ω–∏—Ç–µ –Ω–∞ —ç–ª–µ–º–µ–Ω—Ç, —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å –µ–≥–æ —Ñ–æ—Ä–º—É–ª—ã, –≤—Ö–æ–¥—ã/–≤—ã—Ö–æ–¥—ã –∏ –≤–ª–∏—è–Ω–∏—è –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let cy;
        let architectureData = null;
        let currentFocusedNodeId = null;
        let allLayers = [];
        let activeLayers = new Set();
        let layerCheckboxes = {};

        const categoryColors = {
            '–í–≤–æ–¥ –¥–∞–Ω–Ω—ã—Ö': '#3498db',
            '–ü–∞—Ä–∞–º–µ—Ç—Ä—ã': '#9c27b0',
            '–í–∞–ª–∏–¥–∞—Ü–∏—è': '#9b59b6',
            '–ú–æ–¥–µ–ª–∏ –¥–∞–Ω–Ω—ã—Ö': '#f39c12',
            '–•—Ä–∞–Ω–µ–Ω–∏–µ': '#e67e22',
            '–°–µ—Ä–≤–∏—Å —Å–∏–º—É–ª—è—Ü–∏–∏': '#16a085',
            '–°–µ—Ä–∏–∞–ª–∏–∑–∞—Ü–∏—è': '#8e44ad',
            '–°–∏–º—É–ª—è—Ü–∏—è': '#e74c3c',
            '–†–∞—Å—á–µ—Ç—ã': '#00b894',
            '–†–µ–∑—É–ª—å—Ç–∞—Ç—ã': '#27ae60',
            '–¢–µ—Ö–Ω–∏–∫–∞': '#e91e63',
            '–ò–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞': '#00bcd4',
            '–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è': '#8bc34a',
            '–°–æ–±—ã—Ç–∏–µ': '#ff5722',
            '–û–±—ä–µ–∫—Ç': '#ffc107'
        };

        function fitToScreen() { if (cy) cy.fit(); }
        function zoomIn() { if (cy) cy.zoom(cy.zoom() * 1.2); }
        function zoomOut() { if (cy) cy.zoom(cy.zoom() / 1.2); }

        function clearHighlights() {
            if (!cy) return;
            cy.elements().removeClass('data-flow-highlight').removeClass('data-flow-edge');
            cy.elements().style('opacity', 1);
        }

        function isolateFocusedNode() {
            if (!cy || !currentFocusedNodeId) return;
            const node = cy.getElementById(currentFocusedNodeId);
            if (!node) return;
            const neighborhood = node.closedNeighborhood();
            cy.elements().not(neighborhood).style('display', 'none');
            cy.fit(neighborhood, 80);
        }

        function resetVisibility() {
            if (!cy) return;
            cy.elements().style('display', 'element');
            applyLayerFilter();
            clearHighlights();
            document.getElementById('sidebarContent').innerHTML =
                '<div class="sidebar-empty">–ö–ª–∏–∫–Ω–∏—Ç–µ –Ω–∞ —ç–ª–µ–º–µ–Ω—Ç, —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å –µ–≥–æ —Ñ–æ—Ä–º—É–ª—ã, –≤—Ö–æ–¥—ã/–≤—ã—Ö–æ–¥—ã –∏ –≤–ª–∏—è–Ω–∏—è –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤</div>';
        }

        function highlightDataFlows(node) {
            if (!cy || !architectureData) return;
            clearHighlights();
            currentFocusedNodeId = node.id();

            const outgoingFlows = architectureData.data_flows.filter(flow => flow.source === node.id());
            const incomingFlows = architectureData.data_flows.filter(flow => flow.target === node.id());

            node.addClass('data-flow-highlight');
            outgoingFlows.forEach(flow => {
                const targetNode = cy.getElementById(flow.target);
                if (targetNode) {
                    targetNode.addClass('data-flow-highlight');
                    const edge = cy.getElementById(flow.id);
                    if (edge) edge.addClass('data-flow-edge');
                }
            });
            incomingFlows.forEach(flow => {
                const sourceNode = cy.getElementById(flow.source);
                if (sourceNode) {
                    sourceNode.addClass('data-flow-highlight');
                    const edge = cy.getElementById(flow.id);
                    if (edge) edge.addClass('data-flow-edge');
                }
            });

            const highlighted = cy.collection();
            highlighted.merge(node);
            outgoingFlows.forEach(flow => {
                const t = cy.getElementById(flow.target);
                if (t) highlighted.merge(t);
            });
            incomingFlows.forEach(flow => {
                const s = cy.getElementById(flow.source);
                if (s) highlighted.merge(s);
            });
            cy.elements().difference(highlighted).style('opacity', 0.15);
            cy.animate({ center: { eles: node }, zoom: Math.min(2, Math.max(1, 800 / cy.nodes().length)), duration: 800 });

            showComponentInfo(node.data(), outgoingFlows, incomingFlows);
        }

        function showComponentInfo(componentData, outgoingFlows, incomingFlows) {
            const sidebar = document.getElementById('sidebarContent');
            const categoryClass = `category-${(componentData.category || '').replace(/ /g, '_')}`;
            let html = `
                <div class="info-row">
                    <div class="info-label">–ù–∞–∑–≤–∞–Ω–∏–µ</div>
                    <div class="info-value">
                        <span style="font-size:24px;">${componentData.icon || 'üì¶'}</span>
                        <strong>${escapeHtml(componentData.name || componentData.label)}</strong>
                        ${componentData.category ? `<span class="category-badge ${categoryClass}">${escapeHtml(componentData.category)}</span>` : ''}
                    </div>
                </div>
            `;

            if (componentData.layer) {
                html += `
                    <div class="info-row">
                        <div class="info-label">–°–ª–æ–π</div>
                        <div class="info-value">${escapeHtml(componentData.layer)}</div>
                    </div>
                `;
            }

            if (componentData.description) {
                html += `
                    <div class="info-row">
                        <div class="info-label">–û–ø–∏—Å–∞–Ω–∏–µ</div>
                        <div class="info-value">${escapeHtml(componentData.description)}</div>
                    </div>
                `;
            }

            if (componentData.formula) {
                html += `
                    <div class="info-row">
                        <div class="info-label">–§–æ—Ä–º—É–ª–∞ / –ª–æ–≥–∏–∫–∞ —Ä–∞—Å—á–µ—Ç–∞</div>
                        <div class="info-value formula-block">${escapeHtml(componentData.formula)}</div>
                    </div>
                `;
            }

            if (componentData.type === 'parameter') {
                html += `
                    <div class="info-row">
                        <div class="info-label">–•–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞</div>
                        <div class="info-value">
                            <ul class="parameter-list">
                                <li class="parameter-item"><strong>–ï–¥–∏–Ω–∏—Ü–∞:</strong> ${escapeHtml(componentData.unit || '‚Äî')}</li>
                                <li class="parameter-item"><strong>–û–±—ä–µ–∫—Ç:</strong> ${escapeHtml(componentData.entity || '‚Äî')}</li>
                            </ul>
                        </div>
                    </div>
                `;
            }

            if (incomingFlows.length || outgoingFlows.length) {
                html += `<div class="info-row"><div class="info-label">–ü–æ—Ç–æ–∫–∏ –¥–∞–Ω–Ω—ã—Ö</div><div class="info-value">`;
                if (incomingFlows.length) {
                    html += `<div class="flow-info"><strong>–ü—Ä–∏—Ö–æ–¥–∏—Ç:</strong>`;
                    incomingFlows.forEach(flow => {
                        const unit = flow.metadata && flow.metadata.unit ? `<span class="unit">${flow.metadata.unit}</span>` : '';
                        html += `<p>‚Üê ${escapeHtml(flow.description)} ${unit}</p>`;
                    });
                    html += `</div>`;
                }
                if (outgoingFlows.length) {
                    html += `<div class="flow-info"><strong>–£—Ö–æ–¥–∏—Ç:</strong>`;
                    outgoingFlows.forEach(flow => {
                        const unit = flow.metadata && flow.metadata.unit ? `<span class="unit">${flow.metadata.unit}</span>` : '';
                        html += `<p>‚Üí ${escapeHtml(flow.description)} ${unit}</p>`;
                    });
                    html += `</div>`;
                }
                html += `</div></div>`;
            }

            if (componentData.type === 'parameter' && architectureData.parameter_dependencies) {
                const deps = architectureData.parameter_dependencies[componentData.id] || [];
                if (deps.length) {
                    html += `<div class="info-row"><div class="info-label">–í–ª–∏—è–µ—Ç –Ω–∞</div><div class="info-value"><ul class="parameter-list">`;
                    deps.forEach(depId => {
                        const entity = architectureData.entities.find(e => e.id === depId);
                        if (entity) html += `<li class="parameter-item">${entity.icon || 'üì¶'} ${escapeHtml(entity.name)}</li>`;
                    });
                    html += `</ul></div></div>`;
                }
            }

            sidebar.innerHTML = html;
        }

        function initLayerFilters(nodesData) {
            const layers = new Set();
            nodesData.forEach(node => {
                layers.add(node.data.layer || node.data.category || '–ë–µ–∑ —Å–ª–æ—è');
            });
            allLayers = Array.from(layers).sort();
            activeLayers = new Set(allLayers);
            const container = document.getElementById('layerFilters');
            container.innerHTML = '';
            layerCheckboxes = {};
            allLayers.forEach(layer => {
                const checkboxId = `layer_${layer.replace(/[^a-zA-Z0-9]/g, '_')}`;
                const wrapper = document.createElement('label');
                wrapper.className = 'layer-chip';
                wrapper.innerHTML = `
                    <input type="checkbox" id="${checkboxId}" checked>
                    <span>${layer}</span>
                `;
                container.appendChild(wrapper);
                const checkbox = wrapper.querySelector('input');
                checkbox.addEventListener('change', () => {
                    if (checkbox.checked) activeLayers.add(layer); else activeLayers.delete(layer);
                    applyLayerFilter();
                });
                layerCheckboxes[layer] = checkbox;
            });
            renderLegend();
        }

        function renderLegend() {
            const legend = document.getElementById('layerLegend');
            legend.innerHTML = '';
            allLayers.forEach(layer => {
                const color = categoryColors[layer] || '#95a5a6';
                const item = document.createElement('div');
                item.className = 'legend-item';
                item.innerHTML = `<span class="legend-color" style="background:${color}"></span>${layer}`;
                legend.appendChild(item);
            });
        }

        function applyLayerFilter() {
            if (!cy) return;
            cy.nodes().forEach(node => {
                const layer = node.data('layer') || node.data('category') || '–ë–µ–∑ —Å–ª–æ—è';
                node.style('display', activeLayers.has(layer) ? 'element' : 'none');
            });
            cy.edges().forEach(edge => {
                const sourceVisible = edge.source().style('display') !== 'none';
                const targetVisible = edge.target().style('display') !== 'none';
                edge.style('display', (sourceVisible && targetVisible) ? 'element' : 'none');
            });
        }

        function selectAllLayers() {
            allLayers.forEach(layer => {
                activeLayers.add(layer);
                if (layerCheckboxes[layer]) layerCheckboxes[layer].checked = true;
            });
            applyLayerFilter();
        }

        function deselectAllLayers() {
            activeLayers.clear();
            Object.values(layerCheckboxes).forEach(cb => cb.checked = false);
            applyLayerFilter();
        }

        function handleSearch(query) {
            if (!cy || !query.trim()) {
                clearHighlights();
                return;
            }
            const normalized = query.trim().toLowerCase();
            const node = cy.nodes().toArray().find(n =>
                (n.data('name') || '').toLowerCase().includes(normalized) ||
                (n.data('label') || '').toLowerCase().includes(normalized)
            );
            if (node) highlightDataFlows(node);
        }

        function initCytoscape(data) {
            const container = document.getElementById('cy');
            if (cy) cy.destroy();

            const nodes = [];
            data.entities.forEach(entity => {
                nodes.push({
                    data: {
                        id: entity.id,
                        label: `${entity.icon || 'üì¶'} ${entity.name}`,
                        name: entity.name,
                        description: entity.description || '',
                        category: entity.category || '',
                        layer: entity.layer || entity.category || '–ë–µ–∑ —Å–ª–æ—è',
                        type: entity.type || 'entity',
                        icon: entity.icon || 'üì¶',
                        formula: entity.formula || ''
                    }
                });
            });
            data.parameters.forEach(param => {
                nodes.push({
                    data: {
                        id: param.id,
                        label: `‚öôÔ∏è ${param.name}`,
                        name: param.name,
                        description: `–ü–∞—Ä–∞–º–µ—Ç—Ä: ${param.name}${param.unit ? ` (${param.unit})` : ''}. –û—Ç–Ω–æ—Å–∏—Ç—Å—è –∫: ${param.entity}`,
                        category: param.category || '–ü–∞—Ä–∞–º–µ—Ç—Ä—ã',
                        layer: param.layer || '–ü–∞—Ä–∞–º–µ—Ç—Ä—ã',
                        type: param.type || 'parameter',
                        icon: '‚öôÔ∏è',
                        unit: param.unit || '',
                        entity: param.entity || '',
                        formula: param.formula || ''
                    }
                });
            });

            const nodeIds = new Set(nodes.map(n => n.data.id));
            const edges = (data.data_flows || [])
                .filter(flow => nodeIds.has(flow.source) && nodeIds.has(flow.target))
                .map(flow => ({
                    data: {
                        id: flow.id,
                        source: flow.source,
                        target: flow.target,
                        label: flow.description,
                        category: flow.category,
                        metadata: flow.metadata || {}
                    }
                }));

            cy = cytoscape({
                container,
                elements: { nodes, edges },
                style: [
                    {
                        selector: 'node',
                        style: {
                            'label': 'data(label)',
                            'width': 'label',
                            'height': 'label',
                            'padding': '12px',
                            'text-valign': 'center',
                            'text-halign': 'center',
                            'font-size': '13px',
                            'font-weight': '600',
                            'color': '#2c3e50',
                            'background-color': ele => categoryColors[ele.data('layer')] || '#95a5a6',
                            'border-width': 3,
                            'border-color': '#ffffff',
                            'border-opacity': 0.9,
                            'shape': 'roundrectangle',
                            'text-wrap': 'wrap',
                            'text-max-width': '160px',
                            'text-background-color': 'rgba(255,255,255,0.85)',
                            'text-background-opacity': 1,
                            'text-background-padding': '4px',
                            'text-background-shape': 'roundrectangle'
                        }
                    },
                    {
                        selector: 'node.data-flow-highlight',
                        style: {
                            'border-width': 5,
                            'border-color': '#00b894',
                            'background-color': '#00b894',
                            'color': '#ffffff',
                            'text-background-color': 'rgba(0,0,0,0.6)'
                        }
                    },
                    {
                        selector: 'edge',
                        style: {
                            'width': 3,
                            'line-color': '#7f8c8d',
                            'target-arrow-color': '#7f8c8d',
                            'target-arrow-shape': 'triangle',
                            'target-arrow-size': 10,
                            'curve-style': 'bezier',
                            'opacity': 0.75,
                            'label': 'data(label)',
                            'font-size': '11px',
                            'text-rotation': 'autorotate',
                            'text-margin-y': -8
                        }
                    },
                    {
                        selector: 'edge.data-flow-edge',
                        style: {
                            'width': 5,
                            'line-color': '#00b894',
                            'target-arrow-color': '#00b894',
                            'opacity': 1
                        }
                    }
                ],
                layout: {
                    name: 'breadthfirst',
                    directed: true,
                    roots: ['user_input'],
                    spacingFactor: 2.2,
                    nodeDimensionsIncludeLabels: true,
                    avoidOverlap: true
                }
            });

            cy.on('tap', 'node', evt => highlightDataFlows(evt.target));
            cy.on('tap', evt => {
                if (evt.target === cy) resetVisibility();
            });

            cy.userPanningEnabled(true);
            cy.userZoomingEnabled(true);
            cy.minZoom(0.08);
            cy.maxZoom(5);

            initLayerFilters(nodes);
            applyLayerFilter();
            updateStats(data);
        }

        function updateStats(data) {
            const stats = document.getElementById('stats');
            stats.innerHTML = `
                —ç–ª–µ–º–µ–Ω—Ç–æ–≤: ${data.entities.length} ¬∑ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤: ${data.parameters.length} ¬∑ –ø–æ—Ç–æ–∫–æ–≤: ${data.data_flows.length}<br>
                —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö —Å–ª–æ–µ–≤: ${allLayers.length}
            `;
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text || '';
            return div.innerHTML;
        }

        document.getElementById('fileInput').addEventListener('change', event => {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = e => {
                try {
                    architectureData = JSON.parse(e.target.result);
                    initCytoscape(architectureData);
                } catch (error) {
                    alert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–∞: ' + error.message);
                }
            };
            reader.readAsText(file);
        });

        document.getElementById('searchInput').addEventListener('keydown', e => {
            if (e.key === 'Enter') handleSearch(e.target.value);
        });
        document.getElementById('searchInput').addEventListener('input', e => {
            if (!e.target.value) clearHighlights();
        });

        window.addEventListener('load', () => {
            fetch('S.architecture.json')
                .then(response => {
                    if (response.ok) return response.json();
                    throw new Error('–§–∞–π–ª –Ω–µ –Ω–∞–π–¥–µ–Ω');
                })
                .then(data => {
                    architectureData = data;
                    initCytoscape(data);
                })
                .catch(() => {
                    console.log('–ê–≤—Ç–æ–∑–∞–≥—Ä—É–∑–∫–∞ –Ω–µ —É–¥–∞–ª–∞—Å—å. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–Ω–æ–ø–∫—É "–ó–∞–≥—Ä—É–∑–∏—Ç—å JSON".');
                });
        });
    </script>
</body>
</html>
