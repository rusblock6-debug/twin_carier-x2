<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ü—Ä–æ—Å–º–æ—Ç—Ä—â–∏–∫ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã –ø—Ä–æ–µ–∫—Ç–∞</title>
    <script src="https://unpkg.com/cytoscape@3.26.0/dist/cytoscape.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/default.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            display: flex;
            flex-direction: column;
            height: 100vh;
            overflow: hidden;
            background: #f5f7fa;
        }

        .header {
            background: linear-gradient(135deg, #2c3e50, #34495e);
            color: white;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.15);
            flex-wrap: wrap;
            gap: 10px;
        }

        .header h1 {
            font-size: 20px;
            font-weight: 500;
        }

        .header-controls {
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
        }

        .control-group {
            display: flex;
            gap: 8px;
            align-items: center;
            padding: 0 10px;
            border-right: 1px solid rgba(255,255,255,0.2);
        }
        .control-group:last-child {
            border-right: none;
        }

        .search-container {
            position: relative;
        }

        .search-input {
            padding: 8px 35px 8px 12px;
            border: 1px solid rgba(255,255,255,0.3);
            border-radius: 4px;
            background: white;
            color: #2c3e50;
            font-size: 14px;
            width: 250px;
            transition: all 0.3s ease;
        }

        .search-input::placeholder {
            color: #7f8c8d;
        }

        .search-input:focus {
            outline: none;
            background: white;
            border-color: #3498db;
            width: 300px;
            color: #2c3e50;
        }

        .search-icon {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            color: #7f8c8d;
        }

        .search-results {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #ddd;
            border-radius: 4px;
            max-height: 200px;
            overflow-y: auto;
            display: none;
            z-index: 1000;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .search-result-item {
            padding: 8px 12px;
            cursor: pointer;
            border-bottom: 1px solid #ecf0f1;
            display: flex;
            justify-content: space-between;
            align-items: center;
            color: #2c3e50;
        }

        .search-result-item:hover {
            background: #3498db;
            color: white;
        }

        .search-result-item:last-child {
            border-bottom: none;
        }

        .result-name {
            font-weight: 500;
        }

        .result-layer {
            font-size: 11px;
            opacity: 0.8;
            background: rgba(0,0,0,0.1);
            padding: 2px 6px;
            border-radius: 10px;
        }

        .search-result-item:hover .result-layer {
            background: rgba(255,255,255,0.3);
        }

        .layout-controls {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 8px 16px;
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            white-space: nowrap;
        }

        .btn-icon {
            padding: 8px 12px;
            font-size: 16px;
        }

        .btn:hover:not(:disabled) {
            background: linear-gradient(135deg, #2980b9, #2573a7);
            transform: translateY(-1px);
            box-shadow: 0 4px 6px rgba(0,0,0,0.15);
        }

        .btn:active:not(:disabled) {
            transform: translateY(0);
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }

        .btn:disabled {
            background: #95a5a6;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .btn-secondary {
            background: linear-gradient(135deg, #95a5a6, #839192);
        }

        .btn-secondary:hover:not(:disabled) {
            background: linear-gradient(135deg, #839192, #707b7c);
        }

        .layer-filters {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 10px;
            padding: 10px;
            background: #ecf0f1;
            border-radius: 6px;
            max-height: 120px;
            overflow-y: auto;
            border: 1px solid #dce4e6;
        }

        .layer-filter-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .layer-filter-item input[type="checkbox"] {
            cursor: pointer;
            width: 14px;
            height: 14px;
        }

        .layer-filter-item label {
            cursor: pointer;
            font-size: 12px;
            user-select: none;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .filter-controls {
            margin-top: 10px;
            padding: 15px;
            background: white;
            border-radius: 6px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            border: 1px solid #e1e8ed;
        }

        .filter-controls h3 {
            font-size: 14px;
            margin-bottom: 8px;
            color: #2c3e50;
            font-weight: 600;
        }

        .main-container {
            display: flex;
            flex: 1;
            overflow: hidden;
            flex-direction: column;
            padding: 15px;
            gap: 15px;
        }

        .graph-container {
            flex: 1;
            display: flex;
            overflow: hidden;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            border: 1px solid #e1e8ed;
        }

        #cy {
            flex: 1;
            background: #f8f9fa;
            min-width: 0;
            min-height: 0;
            border-radius: 8px;
        }

        .sidebar {
            width: 400px;
            background: white;
            border-left: 1px solid #e1e8ed;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            box-shadow: -2px 0 8px rgba(0,0,0,0.05);
        }

        .sidebar-header {
            padding: 20px;
            background: linear-gradient(135deg, #ecf0f1, #dde4e6);
            border-bottom: 1px solid #dce4e6;
        }

        .sidebar-header h2 {
            font-size: 18px;
            margin-bottom: 10px;
            color: #2c3e50;
            font-weight: 600;
        }

        .sidebar-content {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
        }

        .sidebar-empty {
            text-align: center;
            color: #7f8c8d;
            padding: 40px 20px;
            font-style: italic;
        }

        .component-info {
            margin-bottom: 15px;
        }

        .info-row {
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 1px solid #ecf0f1;
        }

        .info-row:last-child {
            border-bottom: none;
        }

        .info-label {
            font-weight: 600;
            color: #2c3e50;
            font-size: 13px;
            margin-bottom: 6px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .info-value {
            color: #34495e;
            font-size: 14px;
            word-break: break-word;
            line-height: 1.4;
        }

        .code-block {
            background: #2c3e50;
            border: 1px solid #34495e;
            border-radius: 6px;
            padding: 15px;
            margin-top: 15px;
            max-height: 400px;
            overflow: auto;
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.3);
        }

        .code-block pre {
            margin: 0;
            font-size: 12px;
            line-height: 1.4;
        }

        .file-path {
            font-family: 'Courier New', monospace;
            font-size: 12px;
            color: #7f8c8d;
            background: #ecf0f1;
            padding: 6px 10px;
            border-radius: 4px;
            display: inline-block;
            border: 1px solid #dce4e6;
        }

        .layer-badge {
            display: inline-block;
            padding: 6px 12px;
            border-radius: 16px;
            font-size: 11px;
            font-weight: 600;
            margin-top: 5px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.2);
        }

        .hidden {
            display: none;
        }

        .layer-–ú–æ–¥–µ–ª–∏_–¥–∞–Ω–Ω—ã—Ö { background: linear-gradient(135deg, #e67e22, #d35400); color: white; }
        .layer-–°–µ—Ä–≤–∏—Å—ã { background: linear-gradient(135deg, #27ae60, #229954); color: white; }
        .layer-API_–†–æ—É—Ç—ã { background: linear-gradient(135deg, #3498db, #2980b9); color: white; }
        .layer-–§–æ—Ä–º—ã_–í–∞–ª–∏–¥–∞—Ü–∏—è { background: linear-gradient(135deg, #9b59b6, #8e44ad); color: white; }
        .layer-–î–≤–∏–∂–æ–∫_—Å–∏–º—É–ª—è—Ü–∏–∏ { background: linear-gradient(135deg, #e74c3c, #c0392b); color: white; }
        .layer-–Ø–¥—Ä–æ_—Å–∏–º—É–ª—è—Ü–∏–∏ { background: linear-gradient(135deg, #c0392b, #a93226); color: white; }
        .layer-–†–∞—Å—á—ë—Ç—ã { background: linear-gradient(135deg, #d35400, #ba4a00); color: white; }
        .layer-–ü–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫ { background: linear-gradient(135deg, #8e44ad, #7d3c98); color: white; }
        .layer-–°–∏–º—É–ª—è—Ü–∏–∏ { background: linear-gradient(135deg, #16a085, #138d75); color: white; }
        .layer-–ò–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞ { background: linear-gradient(135deg, #95a5a6, #839192); color: white; }
        .layer-–£—Ç–∏–ª–∏—Ç—ã { background: linear-gradient(135deg, #f39c12, #e67e22); color: white; }
        .layer-–ö–æ–Ω—Å—Ç–∞–Ω—Ç—ã { background: linear-gradient(135deg, #1abc9c, #17a589); color: white; }
        .layer-–ü–µ—Ä–µ—á–∏—Å–ª–µ–Ω–∏—è { background: linear-gradient(135deg, #34495e, #2c3e50); color: white; }
        .layer-–ü—Ä–æ—á–µ–µ { background: linear-gradient(135deg, #7f8c8d, #707b7c); color: white; }

        .action-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .stats {
            font-size: 12px;
            color: #5d6d7e;
            margin-top: 10px;
            font-weight: 500;
        }

        .loading {
            display: none;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(255,255,255,0.9);
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            z-index: 1000;
        }

        .search-highlight {
            background-color: #ffeaa7 !important;
            border-color: #fdcb6e !important;
            border-width: 3px !important;
        }

        .connected-highlight {
            background-color: #a29bfe !important;
            border-color: #6c5ce7 !important;
            border-width: 3px !important;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞</h1>
        <div class="header-controls">
            <input type="file" id="fileInput" accept=".json" style="display: none;">
            <button class="btn" onclick="document.getElementById('fileInput').click()">–ó–∞–≥—Ä—É–∑–∏—Ç—å architecture.json</button>
            
            <!-- –ì—Ä—É–ø–ø–∞ –∫–Ω–æ–ø–æ–∫ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –≤—ã–±–æ—Ä–æ–º -->
            <div class="control-group">
                <button class="btn btn-secondary" id="isolateBtn" onclick="isolateSubgraph()" disabled title="–°–∫—Ä—ã—Ç—å –≤—Å–µ, –∫—Ä–æ–º–µ –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –∏ –µ–≥–æ —Å–≤—è–∑–µ–π">–ò–∑–æ–ª–∏—Ä–æ–≤–∞—Ç—å –ø–æ–¥–≥—Ä–∞—Ñ</button>
                <button class="btn btn-secondary" id="groupBtn" onclick="groupSelected()" disabled title="–°–±–ª–∏–∑–∏—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã">–°–≥—Ä—É–ø–ø–∏—Ä–æ–≤–∞—Ç—å –≤—ã–±—Ä–∞–Ω–Ω–æ–µ</button>
            </div>

            <!-- –ì—Ä—É–ø–ø–∞ –∫–Ω–æ–ø–æ–∫ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ -->
            <div class="control-group">
                <button class="btn btn-icon" onclick="fitToScreen()" title="–ü–æ–∫–∞–∑–∞—Ç—å –≤–µ—Å—å –≥—Ä–∞—Ñ">‚ä°</button>
                <button class="btn btn-icon" id="centerOnSelectionBtn" onclick="centerOnSelection()" disabled title="–¶–µ–Ω—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å –Ω–∞ –≤—ã–¥–µ–ª–µ–Ω–Ω–æ–º">‚óé</button>
                <button class="btn btn-icon" onclick="zoomIn()" title="–ü—Ä–∏–±–ª–∏–∑–∏—Ç—å">+</button>
                <button class="btn btn-icon" onclick="zoomOut()" title="–û—Ç–¥–∞–ª–∏—Ç—å">‚àí</button>
            </div>

            <div class="search-container">
                <input type="text" id="searchInput" class="search-input" placeholder="–ü–æ–∏—Å–∫ –ø–æ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞–º...">
                <div class="search-icon">üîç</div>
                <div class="search-results" id="searchResults"></div>
            </div>
            
            <div class="layout-controls">
                <button class="layout-btn active" onclick="changeLayout('cose-compact')" id="layoutCose">–ö–æ–º–ø–∞–∫—Ç–Ω—ã–π</button>
                <button class="layout-btn" onclick="changeLayout('breadthfirst')" id="layoutBreadth">–î–µ—Ä–µ–≤–æ</button>
                <button class="layout-btn" onclick="changeLayout('circle')" id="layoutCircle">–ö—Ä—É–≥</button>
                <button class="layout-btn" onclick="changeLayout('concentric')" id="layoutConcentric">–ö–æ–Ω—Ü–µ–Ω—Ç—Ä–∏—á–µ—Å–∫–∏–π</button>
                <button class="layout-btn" onclick="changeLayout('grid')" id="layoutGrid">–°–µ—Ç–∫–∞</button>
            </div>
        </div>
    </div>

    <div class="main-container">
        <div class="filter-controls">
            <h3>–§–∏–ª—å—Ç—Ä –ø–æ —Å–ª–æ—è–º</h3>
            <div class="layer-filters" id="layerFilters">
                <!-- –§–∏–ª—å—Ç—Ä—ã –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª–µ–Ω—ã –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
            </div>
            <div style="margin-top: 10px; display: flex; gap: 10px;">
                <button class="btn" onclick="selectAllLayers()">–í—ã–±—Ä–∞—Ç—å –≤—Å–µ</button>
                <button class="btn" onclick="deselectAllLayers()">–°–Ω—è—Ç—å –≤—Å–µ</button>
            </div>
        </div>
        <div class="graph-container">
            <div id="cy"></div>
            <div class="sidebar">
                <div class="sidebar-header">
                    <h2>–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–µ</h2>
                    <div class="stats" id="stats"></div>
                </div>
                <div class="sidebar-content" id="sidebarContent">
                    <div class="sidebar-empty">
                        –í—ã–±–µ—Ä–∏—Ç–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç –Ω–∞ —Å—Ö–µ–º–µ –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –¥–µ—Ç–∞–ª–µ–π
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="loading" id="loading">
        –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ layout... –ü–æ–¥–æ–∂–¥–∏—Ç–µ...
    </div>

    <script>
        let cy;
        let architectureData = null;
        let allLayers = new Set();
        let visibleLayers = new Set();
        let layerCheckboxes = {};
        let currentLayout = 'cose-compact';
        let searchIndex = [];
        let currentSearchResults = [];
        let currentSearchIndex = -1;

        // --- –§—É–Ω–∫—Ü–∏–∏ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ ---
        function fitToScreen() {
            if (cy) cy.fit();
        }
        function centerOnSelection() {
            if (cy && cy.nodes(':selected').length > 0) {
                cy.center(cy.nodes(':selected'));
            }
        }
        function zoomIn() {
            if (cy) cy.zoom(cy.zoom() * 1.2);
        }
        function zoomOut() {
            if (cy) cy.zoom(cy.zoom() / 1.2);
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø–æ–∏—Å–∫–æ–≤–æ–≥–æ –∏–Ω–¥–µ–∫—Å–∞
        function initSearchIndex(data) {
            searchIndex = [];
            data.components.forEach(comp => {
                const searchItem = {
                    id: comp.id,
                    name: comp.name,
                    layer: comp.layer,
                    type: comp.type,
                    file_path: comp.file_path,
                    docstring: comp.docstring || '',
                    methods: comp.methods || [],
                    source_code: comp.source_code || '',
                    searchText: (
                        comp.name + ' ' +
                        comp.layer + ' ' +
                        comp.type + ' ' +
                        comp.file_path + ' ' +
                        (comp.docstring || '') + ' ' +
                        (comp.methods ? comp.methods.join(' ') : '') + ' ' +
                        (comp.source_code || '')
                    ).toLowerCase()
                };
                searchIndex.push(searchItem);
            });
        }

        // –ü–æ–∏—Å–∫ –ø–æ –∏–Ω–¥–µ–∫—Å—É
        function searchComponents(query) {
            if (!query.trim()) return [];
            const searchTerms = query.toLowerCase().split(' ').filter(term => term.length > 0);
            const results = [];
            searchIndex.forEach(item => {
                let score = 0; let matchesAll = true;
                for (const term of searchTerms) {
                    if (item.searchText.includes(term)) {
                        if (item.name.toLowerCase().includes(term)) score += 10;
                        if (item.layer.toLowerCase().includes(term)) score += 5;
                        if (item.type.toLowerCase().includes(term)) score += 3;
                        score += 1;
                    } else { matchesAll = false; break; }
                }
                if (matchesAll && score > 0) { results.push({ ...item, score: score }); }
            });
            return results.sort((a, b) => b.score - a.score).slice(0, 10);
        }

        // –ü–æ–∫–∞–∑–∞—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ–∏—Å–∫–∞
        function showSearchResults(results) {
            const resultsContainer = document.getElementById('searchResults'); resultsContainer.innerHTML = '';
            if (results.length === 0) {
                const noResults = document.createElement('div'); noResults.className = 'search-result-item'; noResults.textContent = '–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ'; noResults.style.cursor = 'default'; noResults.style.opacity = '0.7'; resultsContainer.appendChild(noResults);
            } else {
                results.forEach((result, index) => {
                    const resultItem = document.createElement('div'); resultItem.className = 'search-result-item';
                    resultItem.innerHTML = `<span class="result-name">${escapeHtml(result.name)}</span><span class="result-layer">${escapeHtml(result.layer)}</span>`;
                    resultItem.addEventListener('click', () => { selectSearchResult(result.id); resultsContainer.style.display = 'none'; document.getElementById('searchInput').value = result.name; });
                    resultsContainer.appendChild(resultItem);
                });
            }
            resultsContainer.style.display = 'block'; currentSearchResults = results; currentSearchIndex = -1;
        }

        // –í—ã–¥–µ–ª–∏—Ç—å –Ω–∞–π–¥–µ–Ω–Ω—ã–π –∫–æ–º–ø–æ–Ω–µ–Ω—Ç
        function selectSearchResult(componentId) {
            if (!cy) return; cy.elements().removeClass('search-highlight').removeClass('connected-highlight').style('opacity', 1);
            const node = cy.getElementById(componentId); if (node) { highlightConnectedElements(node); }
        }

        // –ü–æ–¥—Å–≤–µ—Ç–∫–∞ —Å–≤—è–∑–∞–Ω–Ω—ã—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤
        function highlightConnectedElements(node) {
            cy.elements().removeClass('search-highlight').removeClass('connected-highlight').style('opacity', 1); node.style('display', 'element'); node.addClass('search-highlight');
            const connectedEdges = node.connectedEdges(); const connectedNodes = node.connectedNodes();
            connectedNodes.addClass('connected-highlight'); connectedEdges.addClass('search-highlight');
            const highlighted = connectedEdges.union(connectedNodes).union(node); cy.elements().difference(highlighted).style('opacity', 0.2);
            cy.animate({ center: { eles: node }, zoom: Math.min(2, Math.max(1, 800 / cy.nodes().length)), duration: 1000 });
            showComponentInfo(node.data());
        }

        // --- –§—É–Ω–∫—Ü–∏–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –≥—Ä–∞—Ñ–æ–º ---
        function isolateSubgraph() {
            if (!cy) return; const selectedNodes = cy.nodes(':selected'); if (selectedNodes.length === 0) { alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã –¥–ª—è –∏–∑–æ–ª—è—Ü–∏–∏.'); return; }
            let nodesToKeep = selectedNodes; selectedNodes.forEach(node => { nodesToKeep = nodesToKeep.union(node.neighborhood().nodes()); });
            const nodesToKeepSet = new Set(nodesToKeep.map(n => n.id()));
            const edgesToKeep = cy.edges().filter(edge => nodesToKeepSet.has(edge.source().id()) && nodesToKeepSet.has(edge.target().id()));
            const elementsToKeep = nodesToKeep.union(edgesToKeep); cy.elements().difference(elementsToKeep).style('display', 'none');
            applyLayout(currentLayout);
        }

        // –ù–û–í–ê–Ø –§–£–ù–ö–¶–ò–Ø: –°–≥—Ä—É–ø–ø–∏—Ä–æ–≤–∞—Ç—å –≤—ã–±—Ä–∞–Ω–Ω–æ–µ
        function groupSelected() {
            if (!cy) return;
            const selectedNodes = cy.nodes(':selected');
            if (selectedNodes.length < 2) {
                alert('–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞–∫ –º–∏–Ω–∏–º—É–º –¥–≤–∞ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞ –¥–ª—è –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∏.');
                return;
            }

            // 1. –û–ø—Ä–µ–¥–µ–ª—è–µ–º —ç–ª–µ–º–µ–Ω—Ç—ã –¥–ª—è –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∏ (–≤—ã–±—Ä–∞–Ω–Ω—ã–µ –∏ –∏—Ö —Å–æ—Å–µ–¥–∏)
            const nodesToLayout = selectedNodes.union(selectedNodes.neighborhood().nodes());
            const edgesToLayout = nodesToLayout.connectedEdges();
            const elementsToLayout = nodesToLayout.union(edgesToLayout);

            // 2. –ó–∞–ø—É—Å–∫–∞–µ–º –∫–æ–º–ø–∞–∫—Ç–Ω—ã–π –º–∞–∫–µ—Ç –¢–û–õ–¨–ö–û –¥–ª—è —ç—Ç–∏—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤
            const layout = cy.layout({
                name: 'cose',
                eles: elementsToLayout, // –í–∞–∂–Ω—ã–π –ø–∞—Ä–∞–º–µ—Ç—Ä!
                animate: true,
                animationDuration: 500,
                fit: false, // –ù–µ –º–µ–Ω—è–µ–º –æ–±—â–∏–π zoom
                randomize: false,
                nodeRepulsion: 100000,
                idealEdgeLength: 50,
                nodeOverlap: 10
            });

            layout.pon('layoutstop').then(() => {
                // 3. –ü–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –º–∞–∫–µ—Ç–∞, —Ü–µ–Ω—Ç—Ä–∏—Ä—É–µ–º –≤–∏–¥ –Ω–∞ —Å–≥—Ä—É–ø–ø–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö —ç–ª–µ–º–µ–Ω—Ç–∞—Ö
                cy.fit(nodesToLayout, 50);
            });

            layout.run();
        }


        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Ñ–∏–ª—å—Ç—Ä–æ–≤ —Å–ª–æ—ë–≤
        function initLayerFilters(data) {
            allLayers.clear(); const layerCounts = {};
            data.components.forEach(comp => { allLayers.add(comp.layer); layerCounts[comp.layer] = (layerCounts[comp.layer] || 0) + 1; });
            visibleLayers = new Set(allLayers);
            const filtersContainer = document.getElementById('layerFilters'); filtersContainer.innerHTML = ''; layerCheckboxes = {};
            Array.from(allLayers).sort().forEach(layer => {
                const layerKey = layer.replace(/[ /]/g, '_'); const checkboxId = `layer_${layerKey}`; const count = layerCounts[layer];
                const filterItem = document.createElement('div'); filterItem.className = 'layer-filter-item';
                const checkbox = document.createElement('input'); checkbox.type = 'checkbox'; checkbox.id = checkboxId; checkbox.checked = true;
                checkbox.addEventListener('change', function() { if (this.checked) { visibleLayers.add(layer); } else { visibleLayers.delete(layer); } applyLayerFilter(); });
                const label = document.createElement('label'); label.htmlFor = checkboxId;
                label.innerHTML = `<span class="layer-badge layer-${layerKey}" style="font-size: 10px; padding: 2px 6px;">${escapeHtml(layer)} (${count})</span>`;
                filterItem.appendChild(checkbox); filterItem.appendChild(label); filtersContainer.appendChild(filterItem); layerCheckboxes[layer] = checkbox;
            });
        }

        function selectAllLayers() { allLayers.forEach(layer => { visibleLayers.add(layer); if (layerCheckboxes[layer]) layerCheckboxes[layer].checked = true; }); applyLayerFilter(); }
        function deselectAllLayers() { visibleLayers.clear(); Object.values(layerCheckboxes).forEach(checkbox => checkbox.checked = false); applyLayerFilter(); }

        function applyLayerFilter() {
            if (!cy || !architectureData) return; cy.elements().removeClass('search-highlight').removeClass('connected-highlight').style('opacity', 1);
            cy.nodes().forEach(node => { const layer = node.data('layer'); node.style('display', visibleLayers.has(layer) ? 'element' : 'none'); });
            cy.edges().forEach(edge => { const sourceVisible = edge.source().style('display') !== 'none'; const targetVisible = edge.target().style('display') !== 'none'; edge.style('display', (sourceVisible && targetVisible) ? 'element' : 'none'); });
            if (cy.elements(':visible').length > 0) { applyLayout(currentLayout); } updateStats(architectureData);
        }

        function findRootNodes() { if (!cy) return []; const rootNodes = cy.nodes().filter(node => node.indegree() === 0); if (rootNodes.length === 0) { const minIndegree = Math.min(...cy.nodes().map(node => node.indegree())); return cy.nodes().filter(node => node.indegree() === minIndegree); } return rootNodes; }

        function getLayoutOptions(layoutName) {
            const baseOptions = { animate: true, animationDuration: 800, fit: true, padding: 30 };
            const nodeCount = cy ? cy.nodes(':visible').length : 0; const isLargeGraph = nodeCount > 50;
            switch(layoutName) {
                case 'cose-compact': return { ...baseOptions, name: 'cose', idealEdgeLength: isLargeGraph ? 30 : 60, nodeOverlap: 20, componentSpacing: 100, nodeRepulsion: isLargeGraph ? 400000 : 1000000, };
                case 'breadthfirst': const roots = findRootNodes(); const rootIds = roots.map(node => node.id()); return { ...baseOptions, name: 'breadthfirst', directed: true, roots: rootIds.length > 0 ? rootIds : undefined, spacingFactor: 2.5, avoidOverlap: true, nodeDimensionsIncludeLabels: true, };
                case 'circle': return { ...baseOptions, name: 'circle', radius: Math.min(nodeCount * 8, 200), startAngle: 3/2 * Math.PI, sweep: 2 * Math.PI, clockwise: true, equidistant: true };
                case 'concentric': return { ...baseOptions, name: 'concentric', concentric: function(node) { return Array.from(allLayers).indexOf(node.data('layer')); }, levelWidth: function() { return 0.8; }, minNodeSpacing: 20, spacingFactor: 1.1 };
                case 'grid': return { ...baseOptions, name: 'grid', rows: Math.ceil(Math.sqrt(nodeCount)), cols: Math.ceil(Math.sqrt(nodeCount)), position: function(node) { return { row: node.data('gridRow'), col: node.data('gridCol') }; } };
                default: return { ...baseOptions, name: 'random' };
            }
        }

        function applyLayout(layoutName) {
            if (!cy) { console.error("Cytoscape instance 'cy' is not available."); return; }
            const loading = document.getElementById('loading'); loading.style.display = 'block';
            setTimeout(() => {
                try {
                    const layoutOptions = getLayoutOptions(layoutName); const layout = cy.layout(layoutOptions);
                    layout.pon('layoutstop').then(() => { const nodeCount = cy.nodes(':visible').length; const optimalZoom = Math.max(0.3, Math.min(2, 15 / Math.sqrt(nodeCount))); cy.zoom(optimalZoom); cy.center(); loading.style.display = 'none'; });
                    layout.run();
                } catch (error) { console.error('Layout error for', layoutName, ':', error); alert(`–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–∏ –º–∞–∫–µ—Ç–∞ "${layoutName}": ${error.message}.`); loading.style.display = 'none'; }
            }, 100);
        }

        function changeLayout(layoutName) {
            currentLayout = layoutName; document.querySelectorAll('.layout-btn').forEach(btn => btn.classList.remove('active'));
            const layoutIdMap = { 'cose-compact': 'layoutCose', 'breadthfirst': 'layoutBreadth', 'circle': 'layoutCircle', 'concentric': 'layoutConcentric', 'grid': 'layoutGrid' };
            const activeBtn = document.getElementById(layoutIdMap[layoutName]); if (activeBtn) activeBtn.classList.add('active');
            if (layoutName === 'breadthfirst') { cy.style().selector('edge').style('curve-style', 'straight').update(); } else { cy.style().selector('edge').style('curve-style', 'bezier').update(); }
            applyLayout(layoutName);
        }

        function initCytoscape(data) {
            const container = document.getElementById('cy'); if (cy) { cy.destroy(); } initLayerFilters(data); initSearchIndex(data);
            const nodes = data.components.map(comp => ({ data: { id: comp.id, label: comp.name, type: comp.type, layer: comp.layer, file_path: comp.file_path, docstring: comp.docstring || '', source_code: comp.source_code || '', methods: comp.methods || [], }, classes: `layer-${comp.layer.replace(/[ /]/g, '_')}` }));
            const edges = data.relationships.map(rel => ({ data: { id: rel.id, source: rel.source, target: rel.target, type: rel.type, label: rel.description || rel.type } }));
            cy = cytoscape({
                container: container, elements: { nodes: nodes, edges: edges }, style: [
                    { selector: 'node', style: { 'label': 'data(label)', 'width': '70px', 'height': '45px', 'padding': '8px', 'text-valign': 'center', 'text-halign': 'center', 'font-size': '10px', 'font-weight': '600', 'color': '#ffffff', 'border-width': 2, 'border-color': '#ffffff', 'border-opacity': 0.8, 'shape': 'roundrectangle', 'text-wrap': 'wrap', 'text-max-width': '90px', 'text-overflow-wrap': 'anywhere', 'min-zoomed-font-size': 6, 'text-background-color': 'rgba(0,0,0,0.4)', 'text-background-opacity': 1, 'text-background-padding': '2px', 'text-background-shape': 'roundrectangle' } },
                    { selector: 'node.search-highlight', style: { 'border-width': 4, 'border-color': '#ffeaa7', 'border-opacity': 1 } }, { selector: 'node.connected-highlight', style: { 'border-width': 3, 'border-color': '#a29bfe', 'border-opacity': 1 } },
                    { selector: 'edge', style: { 'width': 2, 'line-color': '#7f8c8d', 'target-arrow-color': '#7f8c8d', 'target-arrow-shape': 'triangle', 'target-arrow-size': 8, 'curve-style': 'bezier', 'opacity': 0.8 } },
                    { selector: 'edge.search-highlight', style: { 'width': 3, 'line-color': '#ffeaa7', 'target-arrow-color': '#ffeaa7', 'opacity': 1 } },
                    { selector: 'node:selected', style: { 'border-width': 4, 'border-color': '#3498db', 'border-opacity': 1 } }, { selector: 'node:hover', style: { 'border-width': 3, 'border-color': '#3498db', 'border-opacity': 0.8 } },
                    { selector: 'edge:selected', style: { 'width': 3, 'line-color': '#3498db', 'target-arrow-color': '#3498db', 'opacity': 1 } }, { selector: 'edge:hover', style: { 'width': 3, 'line-color': '#3498db', 'target-arrow-color': '#3498db', 'opacity': 0.9 } }
                ], layout: getLayoutOptions(currentLayout)
            });
            const colorMap = { '–ú–æ–¥–µ–ª–∏_–¥–∞–Ω–Ω—ã—Ö': '#e67e22', '–°–µ—Ä–≤–∏—Å—ã': '#27ae60', 'API_–†–æ—É—Ç—ã': '#3498db', '–§–æ—Ä–º—ã_–í–∞–ª–∏–¥–∞—Ü–∏—è': '#9b59b6', '–î–≤–∏–∂–æ–∫_—Å–∏–º—É–ª—è—Ü–∏–∏': '#e74c3c', '–Ø–¥—Ä–æ_—Å–∏–º—É–ª—è—Ü–∏–∏': '#c0392b', '–†–∞—Å—á—ë—Ç—ã': '#d35400', '–ü–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫': '#8e44ad', '–°–∏–º—É–ª—è—Ü–∏–∏': '#16a085', '–ò–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞': '#95a5a6', '–£—Ç–∏–ª–∏—Ç—ã': '#f39c12', '–ö–æ–Ω—Å—Ç–∞–Ω—Ç—ã': '#1abc9c', '–ü–µ—Ä–µ—á–∏—Å–ª–µ–Ω–∏—è': '#34495e', '–ü—Ä–æ—á–µ–µ': '#7f8c8d' };
            cy.nodes().forEach(node => { const layerKey = node.data('layer').replace(/[ /]/g, '_'); node.style('background-color', colorMap[layerKey] || '#7f8c8d'); });
            cy.on('tap', 'node', function(evt) { highlightConnectedElements(evt.target); });
            cy.on('tap', function(evt) { if (evt.target === cy) { cy.elements().removeClass('search-highlight').removeClass('connected-highlight').style('opacity', 1); clearComponentInfo(); document.getElementById('searchResults').style.display = 'none'; } });
            cy.on('dbltap', 'node', function(evt) { cy.animate({ center: { eles: evt.target }, zoom: 2, duration: 500 }); });
            cy.on('select unselect', 'node', function() {
                const selectedCount = cy.nodes(':selected').length;
                document.getElementById('isolateBtn').disabled = selectedCount === 0;
                document.getElementById('groupBtn').disabled = selectedCount < 2;
                document.getElementById('centerOnSelectionBtn').disabled = selectedCount === 0;
            });
            cy.userPanningEnabled(true); cy.userZoomingEnabled(true); cy.minZoom(0.1); cy.maxZoom(5); cy.boxSelectionEnabled(true); updateStats(data);
        }

        function showComponentInfo(componentData) {
            const sidebar = document.getElementById('sidebarContent'); const layerClass = `layer-${componentData.layer.replace(/[ /]/g, '_')}`;
            let html = `<div class="component-info"><div class="info-row"><div class="info-label">–ò–º—è</div><div class="info-value">${escapeHtml(componentData.label)}</div></div><div class="info-row"><div class="info-label">–¢–∏–ø</div><div class="info-value">${componentData.type === 'class' ? '–ö–ª–∞—Å—Å' : '–§—É–Ω–∫—Ü–∏—è'}</div></div><div class="info-row"><div class="info-label">–°–ª–æ–π</div><div class="info-value"><span class="layer-badge ${layerClass}">${escapeHtml(componentData.layer)}</span></div></div><div class="info-row"><div class="info-label">–§–∞–π–ª</div><div class="info-value"><span class="file-path">${escapeHtml(componentData.file_path)}</span></div></div>`;
            if (componentData.docstring) html += `<div class="info-row"><div class="info-label">–û–ø–∏—Å–∞–Ω–∏–µ</div><div class="info-value">${escapeHtml(componentData.docstring)}</div></div>`;
            if (componentData.methods && componentData.methods.length > 0) html += `<div class="info-row"><div class="info-label">–ú–µ—Ç–æ–¥—ã</div><div class="info-value">${componentData.methods.join(', ')}</div></div>`;
            html += `<div class="action-buttons"><button class="btn" onclick="openInIDE('${escapeHtml(componentData.file_path)}')">–û—Ç–∫—Ä—ã—Ç—å –≤ IDE</button><button class="btn btn-secondary" onclick="showSourceCode('${escapeHtml(componentData.id)}')">–ü–æ–∫–∞–∑–∞—Ç—å –∫–æ–¥</button></div></div>`;
            if (componentData.source_code) html += `<div class="code-block hidden" id="sourceCode_${componentData.id}"><pre><code class="language-python">${escapeHtml(componentData.source_code)}</code></pre></div>`;
            sidebar.innerHTML = html; if (document.querySelector('.code-block:not(.hidden) code')) hljs.highlightAll();
        }

        function showSourceCode(componentId) { const codeBlock = document.getElementById(`sourceCode_${componentId}`); if (codeBlock) { codeBlock.classList.toggle('hidden'); if (!codeBlock.classList.contains('hidden')) hljs.highlightElement(codeBlock.querySelector('code')); } else { alert('–ò—Å—Ö–æ–¥–Ω—ã–π –∫–æ–¥ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω –¥–ª—è —ç—Ç–æ–≥–æ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞'); } }
        function openInIDE(filePath) { const fullPath = filePath.startsWith('qsimmine12/') ? filePath : `qsimmine12/${filePath}`; const url = `vscode://file/${encodeURIComponent(fullPath)}`; const link = document.createElement('a'); link.href = url; link.click(); console.log('–ü—É—Ç—å –∫ —Ñ–∞–π–ª—É:', fullPath); }
        function clearComponentInfo() { const sidebar = document.getElementById('sidebarContent'); sidebar.innerHTML = '<div class="sidebar-empty">–í—ã–±–µ—Ä–∏—Ç–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç –Ω–∞ —Å—Ö–µ–º–µ –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –¥–µ—Ç–∞–ª–µ–π</div>'; if (cy) { cy.elements().removeClass('search-highlight').removeClass('connected-highlight').style('opacity', 1); cy.elements().deselect(); } }
        function updateStats(data) { const stats = document.getElementById('stats'); const visibleCount = cy ? cy.nodes(':visible').length : data.components.length; const visibleEdges = cy ? cy.edges(':visible').length : data.relationships.length; stats.innerHTML = `–í—Å–µ–≥–æ: ${data.components.length} –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤, ${data.relationships.length} —Å–≤—è–∑–µ–π<br>–í–∏–¥–∏–º–æ: ${visibleCount} –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤, ${visibleEdges} —Å–≤—è–∑–µ–π`; }
        function resetView() { if (cy) { cy.elements().style('display', 'element'); applyLayerFilter(); cy.elements().removeClass('search-highlight').removeClass('connected-highlight').style('opacity', 1).deselect(); const nodeCount = cy.nodes(':visible').length; const optimalZoom = Math.max(0.3, Math.min(2, 15 / Math.sqrt(nodeCount))); cy.zoom(optimalZoom); cy.center(); clearComponentInfo(); document.getElementById('searchResults').style.display = 'none'; document.getElementById('searchInput').value = ''; } }
        function escapeHtml(text) { const div = document.createElement('div'); div.textContent = text; return div.innerHTML; }

        document.getElementById('fileInput').addEventListener('change', function(event) { const file = event.target.files[0]; if (!file) return; const reader = new FileReader(); reader.onload = function(e) { try { architectureData = JSON.parse(e.target.result); initCytoscape(architectureData); } catch (error) { alert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–∞: ' + error.message); } }; reader.readAsText(file); });
        window.addEventListener('load', function() { fetch('architecture.json').then(response => { if (response.ok) return response.json(); throw new Error('–§–∞–π–ª –Ω–µ –Ω–∞–π–¥–µ–Ω'); }).then(data => { architectureData = data; initCytoscape(data); }).catch(error => { console.log('–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ –Ω–µ —É–¥–∞–ª–∞—Å—å. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–Ω–æ–ø–∫—É "–ó–∞–≥—Ä—É–∑–∏—Ç—å".'); }); });
        document.getElementById('searchInput').addEventListener('input', function(e) { const query = e.target.value.trim(); if (query.length > 0) { const results = searchComponents(query); showSearchResults(results); } else { document.getElementById('searchResults').style.display = 'none'; currentSearchResults = []; if (cy) { cy.elements().removeClass('search-highlight').removeClass('connected-highlight').style('opacity', 1); } } });
        document.getElementById('searchInput').addEventListener('keydown', function(e) { if (e.key === 'Enter' && currentSearchResults.length > 0) { /* navigateSearchResults(1); */ } else if (e.key === 'Escape') { document.getElementById('searchResults').style.display = 'none'; this.value = ''; if (cy) { cy.elements().removeClass('search-highlight').removeClass('connected-highlight').style('opacity', 1); } } });
        document.addEventListener('click', function(e) { if (!document.querySelector('.search-container').contains(e.target)) { document.getElementById('searchResults').style.display = 'none'; } });
    </script>
</body>
</html>