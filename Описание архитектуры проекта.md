# Обзор архитектуры проекта

Данный проект представляет собой комплексную систему моделирования и анализа карьера, включающую компоненты для сбора метаданных, анализа исходного кода, визуализации, запуска симуляций и их последующего анализа. Архитектура построена по модульному принципу, разделена на слои и контейнеры, реализующие разные аспекты системы.

---

# Общая структура системы

- **Веб-интерфейс**: реализован через статические HTML, CSS, JS файлы, интегрированные с Vue.js и React (в зависимости от страницы). Основной вход — `index.html`, `map.html`, `scenarios.html`, `result.html`.
- **API слой**: реализован через FastAPI, включает маршруты (`routes.py`), обеспечивающие взаимодействие с клиентом, управление моделями, запуском симуляций, получением данных.
- **Модуль анализа кода**: реализован через скрипты `advanced_analyzer.py`, `CursorParser.py`, `CursorParser2.py`, `enhanced_parser.py`, предназначенные для статического анализа исходного кода проекта, построения графов вызовов, определения зависимостей и документации.
- **Модуль моделирования**: включает компоненты для конфигурации (`config.py`), симуляции (`simulate.py`, `simulation_manager.py`), сериализации (`serializer.py`), логирования (`logger.py`), событий (`events.py`) и состояния (`states.py`).
- **Модуль данных**: модели данных реализованы через SQLAlchemy ORM (`models.py`), а также через датаклассы (`props.py`) для передачи данных между компонентами.
- **Модуль утилит**: вспомогательные функции для работы с геоданными (`geo_utils.py`), времени (`date_time_service.py`, `utils.py`), конвертации форматов, безопасности (`secure_filename.py`).
- **Миграции базы данных**: реализованы через Alembic, версии миграций позволяют управлять схемой базы данных.

---

# Контейнеры системы

| Контейнер | Описание | Основные компоненты | Взаимодействия |
|------------|------------|---------------------|----------------|
| **Frontend** | Веб-интерфейс | HTML, CSS, JS, Vue.js, React | Взаимодействие через REST API (`/api/*`) |
| **API сервер** | Обработка HTTP-запросов | FastAPI, маршруты (`routes.py`), схемы (`forms.py`) | Взаимодействие с базой данных, симулятором, клиентом |
| **База данных** | Хранение данных | PostgreSQL (через SQLAlchemy ORM) | Взаимодействие через SQLAlchemy (`models.py`) |
| **Модуль анализа кода** | Статический анализ | `advanced_analyzer.py`, CursorParser, enhanced_parser | Внутренние инструменты для документации и графов вызовов |
| **Модуль моделирования** | Запуск симуляций | `simulate.py`, `simulation_manager.py`, `core` | Взаимодействие с моделями данных, логами, сериализаторами |
| **Модуль сериализации** | Передача данных | `serializer.py`, датаклассы (`props.py`) | Передача данных между слоями, API, симулятором |
| **Модуль логирования** | Логирование событий | `logger.py`, инфраструктура логов | Внутренние компоненты, внешние системы мониторинга |
| **Модуль событий** | Обработка событий | `events.py`, `states.py` | Внутренний цикл симуляции, логика поведения |

---

# Основные компоненты внутри контейнеров

### 1. **Frontend**
- Статические файлы (`index.html`, `map.html`, `scenarios.html`, `result.html`)
- JS-код для взаимодействия с API (`vue.global.js`, `tz_utils.js`, `script.js`)
- Визуализация карт (Leaflet, GeoJSON)

### 2. **API сервер (`routes.py`)**
- Маршруты для получения данных (`/api/quarry-data`, `/api/scenarios`, `/api/road-net/{id}`, `/api/object`, `/run-simulation`)
- Обработка CRUD операций для моделей (`Quarry`, `Shovel`, `Truck`, `Unloading`, `Scenario`)
- Запуск симуляций (`/run-simulation`, `/api/run-simulation`)
- Взаимодействие с базой данных через SQLAlchemy (`get_db`)
- Взаимодействие с Redis (`get_redis`)

### 3. **Модуль моделирования (`simulate.py`, `simulation_manager.py`)**
- Запуск симуляции (`run_simulation`, `run_simulation_for_planned_trips`)
- Обработка конфигурации (`config.py`)
- Взаимодействие с моделями (`props.py`)
- Внутренний цикл симуляции (`environment.py`)
- Обработка ошибок (`exception_traceback.py`)

### 4. **Модуль данных (`models.py`, `props.py`)**
- ORM модели (`Quarry`, `Shovel`, `Truck`, `Unloading`, `Scenario`, `MapOverlay`, `RoadNet`)
- Датаклассы (`SimData`, `Route`, `Point`, `Shift`, `Blasting`, `PlannedIdle`)
- Связи и связи через ForeignKey и relationship

### 5. **Модуль сериализации (`serializer.py`)**
- Конвертация входных данных в датаклассы (`SimDataSerializer`)
- Обработка геоданных, маршрутов, событий

### 6. **Модуль анализа кода (`advanced_analyzer.py`, CursorParser.py, enhanced_parser.py)**
- Статический анализ исходного кода
- Построение графов вызовов
- Документирование классов и функций
- Генерация Markdown и графов

---

# Взаимодействия и потоки данных

- **Веб-клиент**: отправляет запросы к API (`/api/*`), получает JSON-данные, отображает UI.
- **API**: при запуске симуляции (`/run-simulation`) собирает параметры, вызывает `simulation_manager.py`.
- **SimulationManager**: валидирует входные данные, создает внутренний контекст, запускает симуляцию (`simulate.py`).
- **Симуляция**: использует `QSimEnvironment` для моделирования процессов, взаимодействует с моделями (`Shovel`, `Truck`, `Unloading`), логирует события.
- **Результаты**: сериализуются через `serializer.py`, сохраняются в Redis, возвращаются клиенту.
- **Анализ кода**: используется для генерации документации, построения графов вызовов, анализа зависимостей.
- **База данных**: хранит модели, миграции управляются через Alembic, схемы обновляются по миграциям.

---

# Итоговая схема (структура в Mermaid-синтаксис)

```mermaid
graph TD
  subgraph Frontend
    A[HTML/CSS/JS] -->|Взаимодействие| B[API (FastAPI)]
  end
  subgraph API
    B -->|Запросы| C[База данных (PostgreSQL)]
    B -->|Запросы| D[Модуль моделирования]
    B -->|Анализ кода| E[Code Analysis]
    B -->|Запуск симуляции| D
  end
  subgraph Модуль моделирования
    D -->|Запуск| F[Simulation Environment]
    F -->|Обработка| G[Модели: Shovel, Truck, Unloading]
    F -->|Логирование| H[Logger]
    F -->|Результаты| I[Serializer]
  end
  subgraph Анализ кода
    E -->|Графы вызовов| J[Graph Builder]
    E -->|Документация| K[Markdown Generator]
  end
  style Frontend fill:#f9f,stroke:#333,stroke-width:2px
  style API fill:#ccf,stroke:#333,stroke-width:2px
  style Модуль моделирования fill:#cfc,stroke:#333,stroke-width:2px
  style Анализ кода fill:#fcc,stroke:#333,stroke-width:2px
```

---

# Заключение

Архитектура проекта — **модульная, слоистая, контейнеризированная**. Основные слои:
- **Веб-интерфейс** (статические файлы + Vue.js/React)
- **API слой** (FastAPI, маршруты, схемы)
- **Модуль моделирования** (симулятор, логика, сериализация)
- **Данные** (ORM, датаклассы, миграции)
- **Аналитика и документация** (статический анализ, графы вызовов)

Все компоненты взаимодействуют через REST API, внутренние модули — через вызовы функций и сериализацию. В системе реализована гибкая схема расширения, поддержка миграций, логирование и обработка ошибок.
